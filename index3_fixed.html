
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ficha SESAP — Gerar PDF (versão corrigida)</title>

  <!-- html2pdf (usa jsPDF + html2canvas internamente) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
          integrity="sha512-YcsIP6qH7i7u6K8g2hxXb0WvF2w9BWn7w6i9qSxCqN2q0FZ2lq9Qxq4wU3y1rY0r0dY0f3vNf6jJd4b2qG6sA=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    :root{
      --page-w:210mm; --page-h:297mm;
      --accent:#0b75d9;
      --bg:#f5f7f9;
    }
    html,body{height:100%;margin:0;font-family:Inter, "Helvetica Neue", Arial, sans-serif;background:var(--bg);color:#222}
    .wrap{max-width:1100px;margin:18px auto;padding:18px}
    h1{margin:0 0 12px;font-size:20px}
    .topbar{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    .controls{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;background:#fff;padding:12px;border-radius:8px;box-shadow:0 6px 18px rgba(10,20,30,0.06)}
    label{display:block;font-size:12px;color:#444;margin-bottom:6px}
    input[type="text"], input[type="date"], textarea, select {
      width:100%;padding:8px 10px;border:1px solid #d6dde3;border-radius:6px;font-size:14px;box-sizing:border-box;background:#fff;
    }
    textarea{min-height:76px;resize:vertical}
    .actions{display:flex;gap:8px;align-items:center;margin-top:10px}
    button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:600}
    button.ghost{background:#6c757d}
    .preview-wrap{margin-top:16px;display:flex;gap:12px;flex-wrap:wrap}
    .pdf-page{width:794px;background:#fff;padding:26px;border-radius:6px;box-shadow:0 6px 18px rgba(10,20,30,0.08);box-sizing:border-box}
    /* Layout A4 */
    .header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
    .clinic{font-weight:800;font-size:16px}
    .meta{font-size:12px;color:#444;text-align:right}
    .section{margin-bottom:10px}
    .label-box{font-size:11px;color:#666;margin-bottom:6px}
    .field-row{display:flex;gap:10px}
    .col{flex:1}
    .patient-name-box{border:1px dashed #d6dde3;padding:8px;border-radius:6px;min-height:58px;display:flex;align-items:center;overflow:hidden;background:#fbfdff}
    .patient-name{margin:0;font-weight:800;line-height:1.02;word-break:break-word;white-space:normal;font-size:22px}
    .proc-name-box{border:1px dashed #d6dde3;padding:6px;border-radius:6px;min-height:44px;display:flex;align-items:center;overflow:hidden;background:#fff}
    .proc-name{margin:0;font-weight:700;line-height:1.02;word-break:break-word;white-space:normal;font-size:18px}
    .notes{border:1px solid #e6ebef;padding:8px;border-radius:6px;min-height:56px;font-size:13px;background:#fff}
    .footer{margin-top:12px;font-size:11px;color:#555}
    @media (max-width:980px){
      .controls{grid-template-columns:1fr}
      .pdf-page{width:100%}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Ficha SESAP — Preencher e gerar PDF (corrigido)</h1>

    <div class="topbar">
      <div style="flex:1">
        <small style="color:#555">Arquivo local — sem envio para planilha</small>
      </div>
      <div class="actions">
        <button id="btn-update">Atualizar prévia</button>
        <button id="btn-generate">Gerar PDF</button>
        <button id="btn-clear" class="ghost">Limpar</button>
      </div>
    </div>

    <div class="controls" role="form" aria-label="Formulário de ficha">
      <div>
        <label for="nome">Nome completo do paciente</label>
        <input id="nome" type="text" placeholder="Ex: Luzimar Silva Rego do Nascimento" />
      </div>

      <div>
        <label for="nome_mae">Nome da mãe</label>
        <input id="nome_mae" type="text" placeholder="Nome da mãe" />
      </div>

      <div>
        <label for="cpf">CPF / SUS / Documento</label>
        <input id="cpf" type="text" placeholder="CPF ou número SUS" />
      </div>

      <div>
        <label for="nascimento">Data de nascimento</label>
        <input id="nascimento" type="date" />
      </div>

      <div>
        <label for="sexo">Sexo</label>
        <select id="sexo">
          <option value="">—</option>
          <option>Masculino</option>
          <option>Feminino</option>
          <option>Outro/Não informado</option>
        </select>
      </div>

      <div>
        <label for="procedimento">Nome do procedimento / Diagnóstico</label>
        <input id="procedimento" type="text" placeholder="Ex: Cirurgia vascular de fístula arteriovenosa" />
      </div>

      <div style="grid-column:1 / -1">
        <label for="observacoes">Observações clínicas / orientações</label>
        <textarea id="observacoes" placeholder="Observações, condutas, alergias, etc."></textarea>
      </div>

      <div>
        <label for="atendente">Profissional / Atendente</label>
        <input id="atendente" type="text" placeholder="Nome do profissional" />
      </div>

      <div>
        <label for="data_atendimento">Data do atendimento</label>
        <input id="data_atendimento" type="date" />
      </div>

      <div>
        <label for="local">Unidade / Local</label>
        <input id="local" type="text" placeholder="Ex: Unidade X — SESAP" />
      </div>
    </div>

    <div class="preview-wrap">
      <div id="pdf-root" class="pdf-page" role="document" aria-label="Pré-visualização do PDF">
        <div class="header">
          <div class="clinic">SESAP — Ficha do Paciente</div>
          <div class="meta">
            <div id="meta-pront">Documento: —</div>
            <div id="meta-nasc">Nascimento: —</div>
          </div>
        </div>

        <div class="section">
          <div class="label-box">Nome do paciente</div>
          <div class="patient-name-box" aria-hidden="false">
            <p id="preview-nome" class="patient-name">—</p>
          </div>
        </div>

        <div class="section">
          <div class="label-box">Nome do procedimento / diagnóstico</div>
          <div class="proc-name-box">
            <p id="preview-proc" class="proc-name">—</p>
          </div>
        </div>

        <div class="section field-row">
          <div class="col">
            <div class="label-box">Nome da mãe</div>
            <div id="preview-mae" class="notes" style="min-height:38px;padding:6px 8px">—</div>
          </div>
          <div style="width:180px">
            <div class="label-box">Sexo</div>
            <div id="preview-sexo" class="notes" style="min-height:38px;padding:6px 8px">—</div>
          </div>
        </div>

        <div class="section">
          <div class="label-box">Observações</div>
          <div id="preview-obs" class="notes">—</div>
        </div>

        <div class="section field-row">
          <div class="col">
            <div class="label-box">Profissional / Atendente</div>
            <div id="preview-att" class="notes" style="min-height:36px;padding:6px 8px">—</div>
          </div>
          <div style="width:180px">
            <div class="label-box">Data atendimento</div>
            <div id="preview-data" class="notes" style="min-height:36px;padding:6px 8px">—</div>
          </div>
        </div>

        <div class="footer">
          Documento gerado em: <span id="gerado-em">—</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Short helpers
    const $ = id => document.getElementById(id);

    // Break long text into multiple lines by words so fields can wrap better.
    function breakLongText(text, maxCharsPerLine){
      if(!text) return '';
      const words = text.split(/\s+/);
      let line = '';
      const lines = [];
      for(const w of words){
        if((line + ' ' + w).trim().length > maxCharsPerLine){
          if(line) lines.push(line.trim());
          // if single word longer than limit, break word
          if(w.length > maxCharsPerLine){
            let pos = 0;
            while(pos < w.length){
              lines.push(w.substr(pos, maxCharsPerLine));
              pos += maxCharsPerLine;
            }
            line = '';
          } else {
            line = w;
          }
        } else {
          line = (line + ' ' + w).trim();
        }
      }
      if(line) lines.push(line.trim());
      return lines.join('\\n');
    }

    // Fit text to a container by binary-searching font-size.
    function fitTextToBox(textEl, containerEl, opts = {}){
      const maxSize = opts.maxSizePx || 34;
      const minSize = opts.minSizePx || 8;
      const precision = opts.precision || 0.5;

      textEl.style.whiteSpace = 'normal';
      textEl.style.display = 'block';
      textEl.style.margin = '0';

      let low = minSize, high = maxSize, best = minSize;

      function fits(fontSize){
        textEl.style.fontSize = fontSize + 'px';
        // Allow small tolerance
        return textEl.scrollWidth <= containerEl.clientWidth + 0.5 && textEl.scrollHeight <= containerEl.clientHeight + 0.5;
      }

      if(!fits(minSize)){
        textEl.style.fontSize = minSize + 'px';
        return;
      }

      while((high - low) > precision){
        const mid = (low + high)/2;
        if(fits(mid)){
          best = mid;
          low = mid;
        } else {
          high = mid;
        }
      }
      textEl.style.fontSize = Math.max(minSize, Math.round(best*10)/10) + 'px';
    }

    // Update preview
    function atualizarPreview(){
      const nome = $('nome').value.trim() || '—';
      const proc = $('procedimento').value.trim() || '—';
      const mae = $('nome_mae').value.trim() || '—';
      const cpf = $('cpf').value.trim() || '—';
      const nasc = $('nascimento').value || '—';
      const sexo = $('sexo').value || '—';
      const obs = $('observacoes').value.trim() || '—';
      const att = $('atendente').value.trim() || '—';
      const dataAt = $('data_atendimento').value || '—';
      const local = $('local').value.trim() || '—';

      // Break long text for patient and procedure
      const nomeBroken = breakLongText(nome, 28); // aggressive enough for long names
      const procBroken = breakLongText(proc, 34); // procedure names usually longer words allowed per line

      $('preview-nome').textContent = nomeBroken || '—';
      $('preview-proc').textContent = procBroken || '—';
      $('preview-mae').textContent = mae;
      $('preview-sexo').textContent = sexo;
      $('preview-obs').textContent = obs;
      $('preview-att').textContent = att;
      $('preview-data').textContent = dataAt;
      $('meta-pront').textContent = 'Documento: ' + cpf;
      $('meta-nasc').textContent = 'Nascimento: ' + (nasc === '—' ? '—' : new Date(nasc).toLocaleDateString());

      $('gerado-em').textContent = new Date().toLocaleString();

      // Fit text into boxes
      fitTextToBox($('preview-nome'), $('preview-nome').parentElement, { maxSizePx: 34, minSizePx: 10, precision: 0.2 });
      fitTextToBox($('preview-proc'), $('preview-proc').parentElement, { maxSizePx: 20, minSizePx: 9, precision: 0.2 });

      // If proc is multiple lines, slightly reduce font more for safety
      const numLinesProc = (procBroken.match(/\\n/g) || []).length + 1;
      if(numLinesProc > 1){
        const curr = parseFloat(window.getComputedStyle($('preview-proc')).fontSize);
        const reduced = Math.max(8, Math.round(curr * Math.pow(0.9, numLinesProc - 1)));
        $('preview-proc').style.fontSize = reduced + 'px';
      }

      const numLinesNome = (nomeBroken.match(/\\n/g) || []).length + 1;
      if(numLinesNome > 1){
        const curr = parseFloat(window.getComputedStyle($('preview-nome')).fontSize);
        const reduced = Math.max(8, Math.round(curr * Math.pow(0.9, numLinesNome - 1)));
        $('preview-nome').style.fontSize = reduced + 'px';
      }
    }

    // Generate PDF using html2pdf with A4 settings
    function gerarPDF(){
      // ensure preview up to date
      atualizarPreview();

      const element = document.getElementById('pdf-root');

      const opt = {
        margin:       [10,10,10,10],
        filename:     'ficha_sesap.pdf',
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2, useCORS: true, logging: false },
        jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };

      // Temporarily expand font sizes for better pdf rendering fidelity if needed
      const nomeEl = $('preview-nome');
      const procEl = $('preview-proc');

      // Use a copy to avoid layout shifts: clone node and render clone offscreen
      const clone = element.cloneNode(true);
      clone.style.boxShadow = 'none';
      clone.style.margin = '0';
      clone.style.transform = 'scale(1)';
      clone.style.width = '210mm'; // make clone width match A4
      clone.id = 'pdf-root-clone';
      document.body.appendChild(clone);

      // Render cloned element
      html2pdf().set(opt).from(clone).save().then(() => {
        // cleanup
        setTimeout(()=>{ try{ document.body.removeChild(clone); }catch(e){} }, 800);
      }).catch((err)=>{
        console.error('Erro ao gerar PDF', err);
        try{ document.body.removeChild(clone); }catch(e){}
        alert('Erro ao gerar PDF: ' + (err && err.message ? err.message : err));
      });
    }

    // Bind buttons
    document.addEventListener('DOMContentLoaded', ()=>{
      $('btn-update').addEventListener('click', atualizarPreview);
      $('btn-generate').addEventListener('click', gerarPDF);
      $('btn-clear').addEventListener('click', ()=>{
        ['nome','nome_mae','cpf','nascimento','sexo','procedimento','observacoes','atendente','data_atendimento','local']
          .forEach(id => { $(id).value = ''; });
        atualizarPreview();
      });

      // Live update on input (small debounce)
      let t;
      ['nome','procedimento','nome_mae','cpf','nascimento','sexo','observacoes','atendente','data_atendimento','local']
        .forEach(id=>{
          $(id).addEventListener('input', ()=>{ clearTimeout(t); t = setTimeout(atualizarPreview, 220); });
        });

      // initial preview
      atualizarPreview();
    });
  </script>
</body>
</html>
