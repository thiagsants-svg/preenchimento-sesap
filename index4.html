<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>SESAP - 5 procedimentos por vez</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f5f5f5;margin:0;padding:20px}
    .container{max-width:900px;margin:0 auto}
    .card{background:#fff;border-radius:8px;padding:18px;margin-bottom:14px;box-shadow:0 2px 4px rgba(0,0,0,.08)}
    h1{text-align:center;background:#2180b9;color:#fff;padding:16px;border-radius:8px;margin:0 0 18px}
    .title{font-weight:600;color:#2180b9;margin-bottom:10px;border-bottom:2px solid #2180b9;padding-bottom:4px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:10px}
    .row.full{grid-template-columns:1fr}
    label{font-size:13px;font-weight:600;margin-bottom:4px;display:block}
    input{width:100%;padding:8px;border:1px solid #ddd;border-radius:5px;font-size:13px}
    input:focus{outline:none;border-color:#2180b9;box-shadow:0 0 0 2px rgba(33,128,185,.15)}
    .proc{background:#f9f9f9;border-radius:6px;padding:10px;margin-bottom:8px;border-left:4px solid #2180b9}
    button{border:none;border-radius:6px;padding:10px 18px;font-size:14px;font-weight:600;cursor:pointer}
    .btn-main{width:100%;background:#2180b9;color:#fff;margin-top:6px}
    .btn-main:hover{background:#1a6fa3}
    .btn-add{background:#95a5a6;color:#fff;margin-top:6px}
    .btn-add:hover{background:#7f8c8d}
    .btn-rem{background:#e74c3c;color:#fff;margin-top:6px}
    .btn-rem:hover{background:#c0392b}
    .status{margin-top:10px;padding:8px;border-radius:6px;display:none;font-size:13px}
    .ok{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .err{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
  </style>
</head>
<body>
<div class="container">
  <h1>SESAP - Preencher sesapnew.pdf (at√© 5 procedimentos)</h1>

  <div class="card">
    <div class="title">Dados gerais</div>
    <div class="row">
      <div>
        <label>Hospital</label>
        <input id="hospital" value="HOSPITAL RIO GRANDE">
      </div>
      <div>
        <label>Data</label>
        <input type="date" id="data">
      </div>
    </div>
  </div>

  <div class="card">
    <div class="title">Paciente</div>
    <div class="row full">
      <div>
        <label>Nome do paciente</label>
        <input id="paciente" placeholder="Nome completo">
      </div>
    </div>
  </div>

  <div class="card">
    <div class="title">Equipe</div>
    <div class="row">
      <div>
        <label>Cirurgi√£o</label>
        <input id="cirurgiao" value="Jos√© Augusto">
      </div>
      <div>
        <label>M√©dico auxiliar</label>
        <input id="auxiliar" placeholder="Nome do auxiliar">
      </div>
    </div>
    <div class="row">
      <div>
        <label>Empresa cirurgi√£o</label>
        <input id="empresaCir" value="Targino & Rocha">
      </div>
      <div>
        <label>Anestesista</label>
        <input id="anest" value="Thiago Jos√©">
      </div>
    </div>
    <div class="row full">
      <div>
        <label>Empresa anestesista</label>
        <input id="empresaAnest" value="COOPANEST RN">
      </div>
    </div>
  </div>

  <div class="card">
    <div class="title">Procedimentos (m√°x. 5)</div>
    <div id="procs"></div>
    <button type="button" class="btn-add" onclick="addProc()">+ Adicionar procedimento</button>
  </div>

  <button class="btn-main" onclick="gerar()">üìÑ Gerar PDF (2 p√°ginas)</button>
  <div id="status" class="status"></div>
</div>

<script>
const { PDFDocument } = PDFLib;
let count = 0;

document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('data').value = new Date().toISOString().split('T')[0];
  addProc();
});

function addProc(){
  if(count>=5){ msg('M√°ximo de 5 procedimentos por vez.',false); return; }
  count++;
  const d=document.createElement('div');
  d.className='proc';
  d.id='p'+count;
  d.innerHTML=`
    <div style="font-weight:bold;margin-bottom:4px">Procedimento ${count}</div>
    <label>Descri√ß√£o / cirurgia</label>
    <input id="desc${count}" placeholder="Ex: Trombectomia de art√©ria femoral direita">
    <label style="margin-top:6px">Grupo</label>
    <input id="grupo${count}" value="GRUPO V">
    <button type="button" class="btn-rem" onclick="this.parentElement.remove()">Remover</button>
  `;
  document.getElementById('procs').appendChild(d);
}

function msg(t,ok){
  const s=document.getElementById('status');
  s.textContent=t;
  s.className='status '+(ok?'ok':'err');
  s.style.display='block';
}

async function gerar(){
  const paciente=document.getElementById('paciente').value.trim();
  if(!paciente){ msg('Informe o nome do paciente.',false); return; }

  const procs=[];
  for(let i=1;i<=5;i++){
    const d=document.getElementById('desc'+i);
    const g=document.getElementById('grupo'+i);
    if(d && d.value.trim()){
      procs.push({desc:d.value.trim(),grupo:g?g.value.trim():''});
    }
  }
  if(!procs.length){ msg('Adicione ao menos 1 procedimento.',false); return; }

  const dados={
    hospital:document.getElementById('hospital').value,
    data:document.getElementById('data').value,
    paciente,
    cir:document.getElementById('cirurgiao').value,
    aux:document.getElementById('auxiliar').value,
    empCir:document.getElementById('empresaCir').value,
    anest:document.getElementById('anest').value,
    empAnest:document.getElementById('empresaAnest').value
  };
  const equipe=[dados.cir,dados.aux,dados.anest].filter(Boolean).join(', ');

  const resp=await fetch('sesapnew.pdf');
  if(!resp.ok){ alert('Erro ao carregar sesapnew.pdf: '+resp.status); msg('Erro ao carregar sesapnew.pdf.',false); return;}
  const bytes=await resp.arrayBuffer();
  const base=await PDFDocument.load(bytes);
  const out=await PDFDocument.create();

  const [pBaseCir]=await out.copyPages(base,[0]);
  out.addPage(pBaseCir);
  const [pBaseAn]=await out.copyPages(base,[0]);
  out.addPage(pBaseAn);

  const form=out.getForm();

  // cabe√ßalhos (mesmos campos nas 2 p√°ginas)
  try{
    form.getTextField('HOSPITAL').setText(dados.hospital);
    form.getTextField('DATA').setText(dados.data);
  }catch(e){}

  // p√°gina cirurgi√£o
  try{
    form.getTextField('EMPRESA').setText(dados.empCir);
    form.getTextField('EQUIPE').setText(equipe);
  }catch(e){}

  const nomesProc=['PROCEDIMENTO_01','PROCEDIMENTO_02','PROCEDIMENTO_03','PROCEDIMENTO_04','PROCEDIMENTO_05'];
  const nomesPac=['PACIENTE01','PACIENTE02','PACIENTE03','PACIENTE04','PACIENTE05'];
  const nomesGrupo=['grupo_proc01','grupo_proc02','grupo_proc03','grupo_proc04','grupo_proc05'];
  const nomesMedP=['MEDICO_PRINC_01','MEDICO_PRINC_02','MEDICO_PRINC_03','MEDICO_PRINC_04','MEDICO_PRINC_05'];
  const nomesMedA=['MEDICO_AUX_01','MEDICO_AUX_02','MEDICO_AUX_03','MEDICO_AUX_04','MEDICO_AUX_05'];

  // preenche linhas (como os campos s√£o compartilhados, o que vale √© o √∫ltimo valor setado)
  procs.forEach((p,i)=>{
    try{
      form.getTextField(nomesProc[i]).setText(p.desc);
      form.getTextField(nomesPac[i]).setText(dados.paciente);
      form.getTextField(nomesGrupo[i]).setText(p.grupo);
      form.getTextField(nomesMedP[i]).setText(dados.cir);
      form.getTextField(nomesMedA[i]).setText(dados.aux||'');
    }catch(e){}
  });

  // agora ajusta para p√°gina do anestesista: muda EMPRESA e m√©dico principal
  try{
    form.getTextField('EMPRESA').setText(dados.empAnest);
    procs.forEach((p,i)=>{
      form.getTextField(nomesMedP[i]).setText(dados.anest);
      form.getTextField(nomesMedA[i]).setText(''); // auxiliar em branco
    });
  }catch(e){}

  const final=await out.save();
  const blob=new Blob([final],{type:'application/pdf'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download='SESAP_'+(dados.data||'hoje')+'.pdf';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  msg('PDF gerado. Para mais de 5 procedimentos, repita o processo.',true);
}
</script>
</body>
</html>
