<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SESAP Ninja — Assassine a burocracia</title>

<!-- pdf-lib -->
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" sizes="180x180" href="ninja-icon-180.png">
<link rel="icon" type="image/png" sizes="32x32" href="ninja-icon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="ninja-icon-16.png">
<link rel="shortcut icon" href="favicon.ico">
<meta name="theme-color" content="#0fb0a8">

<style>
/* --- ESTILO COMPLETO SESAP NINJA (NIGHT MODE) --- */
:root{
  --bg:#050814;
  --card:#061025;
  --muted:#9fb3c2;
  --text:#eaf6f7;
  --accent:#0fb0a8;
  --accent-2:#7a5ef1;
  --danger:#ff6b6b;
  --radius:12px;
  --shadow: 0 12px 36px rgba(2,6,12,0.6);
}
html,body{
  height:100%;margin:0;background:linear-gradient(180deg,#02040a 0%,var(--bg) 70%);
  color:var(--text);font-family:Inter,system-ui,Arial;-webkit-font-smoothing:antialiased;
}
.wrap{max-width:1150px;margin:20px auto;padding:18px;}
header{display:flex;gap:12px;align-items:center;margin-bottom:18px}
.badge{
  width:64px;height:64px;border-radius:14px;
  background:linear-gradient(135deg,var(--accent-2),var(--accent));
  display:flex;align-items:center;justify-content:center;
  box-shadow:var(--shadow)
}
.badge img{width:46px;height:46px}
h1{margin:0;font-size:1.12rem}
p.lead{margin:4px 0 0;color:var(--muted);font-size:0.92rem}

.grid{display:grid;grid-template-columns:1fr 350px;gap:18px}
@media(max-width:980px){.grid{grid-template-columns:1fr}}

.card{
  background:var(--card);border-radius:12px;
  padding:16px;box-shadow:var(--shadow)
}

label{font-weight:700;margin-bottom:6px;font-size:0.88rem}
input,select{
  width:100%;padding:10px;border-radius:8px;
  border:1px solid rgba(255,255,255,.08);
  background:transparent;color:var(--text);
  font-size:0.95rem;
}
select{-webkit-appearance:none;-moz-appearance:none;appearance:none;padding-right:24px}
.select-wrap{position:relative}
.select-wrap:after{
  content:"▾";position:absolute;right:10px;top:50%;transform:translateY(-50%);
  color:var(--muted);pointer-events:none
}

#procedimentos{display:flex;flex-direction:column;gap:10px;max-height:430px;overflow:auto;margin-top:12px}
.linha-proc{
  display:grid;grid-template-columns:1fr 180px 48px;
  gap:10px;padding:12px;border-radius:10px;
  background:rgba(255,255,255,.03);
  border:1px solid rgba(255,255,255,.06)
}

.btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
.btn.primary{
  background:linear-gradient(90deg,var(--accent-2),var(--accent));
  color:#021014
}
.btn.ghost{
  background:rgba(255,255,255,.06);
  color:var(--text)
}
.small{
  padding:6px 10px;font-size:0.85rem;
  border-radius:8px;border:1px solid rgba(255,255,255,.04);
  background:transparent;color:var(--accent);cursor:pointer
}
.shortcuts{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
.shortcut{
  padding:6px 12px;border-radius:999px;
  border:1px solid rgba(255,255,255,.06);
  background:transparent;
  color:var(--accent);cursor:pointer;font-weight:700;font-size:0.85rem
}

.typeahead-box{
  position:absolute;z-index:5000;
  background:#061626;border-radius:8px;width:100%;
  border:1px solid rgba(255,255,255,.05);
  max-height:260px;overflow-y:auto;
  box-shadow:0 12px 36px rgba(0,0,0,.6)
}
.typeahead-item{padding:10px;cursor:pointer}
.typeahead-item:hover{background:rgba(255,255,255,.06)}
.typeahead-sub{font-size:0.8rem;color:var(--muted)}

.procedimentos-placeholder{
  text-align:center;padding:24px;
  border-radius:12px;color:var(--muted);
  border:1px dashed rgba(255,255,255,.08);
  background:rgba(255,255,255,.03)
}
.quick-add{
  padding:8px 16px;border-radius:999px;
  background:linear-gradient(90deg,var(--accent-2),var(--accent));
  color:#021014;font-weight:700;cursor:pointer
}
</style>
</head>

<body>
<div class="wrap">
<header>
  <div class="badge"><img src="ninja.png"></div>
  <div>
    <h1>SESAP Ninja — <span style="color:var(--accent)">Assassine a burocracia</span></h1>
    <p class="lead">Preenchimento ultra-rápido com autocomplete + atalhos.</p>
  </div>
</header>

<div class="grid">
<div>
<div class="card">
  <label>Hospital</label>
  <input id="hospital" value="HOSPITAL RIO GRANDE">

  <label style="margin-top:12px">Data</label>
  <input type="date" id="data">

  <div class="row" style="margin-top:12px">
    <div class="col">
      <label>Cirurgião</label>
      <div class="select-wrap">
        <select id="cirurgiao_select">
          <option value="José Augusto">José Augusto</option>
          <option value="Harue Kumakura">Harue Kumakura</option>
          <option value="José Linhares">José Linhares</option>
          <option value="Yuri Lourenço">Yuri Lourenço</option>
          <option value="__outro__">Outro...</option>
        </select>
      </div>
      <input id="cirurgiao_outro" placeholder="Outro cirurgião" style="display:none;margin-top:6px">
    </div>

    <div class="col">
      <label>Auxiliar</label>
      <div class="select-wrap">
        <select id="aux_select">
          <option value="">—</option>
          <option value="Harue Kumakura">Harue Kumakura</option>
          <option value="José Linhares">José Linhares</option>
          <option value="Yuri Lourenço">Yuri Lourenço</option>
          <option value="__outro__">Outro...</option>
        </select>
      </div>
      <input id="aux_outro" placeholder="Outro auxiliar" style="display:none;margin-top:6px">
    </div>
  </div>

  <label style="margin-top:12px">Anestesista</label>
  <div class="select-wrap">
    <select id="anest_select">
      <option value="Thiago José">Thiago José</option>
      <option value="Bruno Sinedino">Bruno Sinedino</option>
      <option value="__outro__">Outro...</option>
    </select>
  </div>
  <input id="anest_outro" placeholder="Outro anestesista" style="display:none;margin-top:6px">

  <label style="margin-top:12px">Empresa do cirurgião</label>
  <input id="emp_cir" value="Targino & Rocha">

  <label style="margin-top:12px">Empresa do anestesista</label>
  <input id="emp_anest" value="COOPANEST RN">

  <label style="margin-top:14px">Paciente</label>
  <input id="paciente" placeholder="Nome completo do paciente">

  <hr style="margin:22px 0;border-color:rgba(255,255,255,.06)">

  <h3 style="margin:0 0 4px">Procedimentos</h3>
  <div id="shortcuts" class="shortcuts"></div>

  <datalist id="groups-datalist"></datalist>

  <div id="procedimentos-placeholder" class="procedimentos-placeholder">
    Nenhum procedimento.  
    <br><br><button class="quick-add" onclick="addProc()">Adicionar procedimento</button>
  </div>

  <div id="procedimentos"></div>

  <div style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap">
    <button class="btn primary" onclick="gerarPdf({preview:true})">Pré-visualizar PDF</button>
    <button class="btn ghost" onclick="gerarPdf({preview:false})">Gerar e baixar</button>
    <button class="btn small" style="color:var(--accent)" onclick="sendCountsToGoogleForm()">Enviar para planilha</button>
  </div>

</div>
</div>
<!-- ======================= -->
<!-- ====  PARTE 2      ==== -->
<!-- ======================= -->

<script>
/* ===========================================
   CONFIGURAÇÃO DO FORM (AUTO-DETECÇÃO entry.*)
   =========================================== */

const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSdg11eUTNyIsV4-GbY4V5iimX95DCveyIopUMMG82Ml-xLwqw";
const GOOGLE_VIEW      = GOOGLE_FORM_URL + "/viewform";
const GOOGLE_RESPONSE  = GOOGLE_FORM_URL + "/formResponse";

// Aqui ficam armazenados os entry.xxxxx detectados
let GFIELDS = {
  paciente: "",
  grupoI: "",
  grupoII: "",
  grupoIII: "",
  grupoIV: "",
  grupoV: "",
  cirurgiao: "",
  auxiliar: "",
  d_day: "",
  d_month: "",
  d_year: ""
};

/* Função que detecta automaticamente todos os entry.xxxx */
async function detectarEntryIDs() {
  try {
    const html = await fetch(GOOGLE_VIEW).then(r => r.text());

    // Mapa de palavras-chave → campos esperando entry.*
    const mapa = {
      paciente:  /paciente/gi,
      grupoI:    /grupo\s*I\b/gi,
      grupoII:   /grupo\s*II\b/gi,
      grupoIII:  /grupo\s*III\b/gi,
      grupoIV:   /grupo\s*IV\b/gi,
      grupoV:    /grupo\s*V\b/gi,
      cirurgiao: /cirurgi[aã]o/gi,
      auxiliar:  /auxiliar/gi,
      d_day:     /dia|day/gi,
      d_month:   /m[eê]s|month/gi,
      d_year:    /ano|year/gi
    };

    const entradas = [...html.matchAll(/name="(entry\.\d+)"/g)].map(m => m[1]);

    entradas.forEach(entry => {
      const linha = html.split(entry)[0].slice(-120); // pega contexto antes do entry
      for (const campo in mapa) {
        if (mapa[campo].test(linha)) {
          GFIELDS[campo] = entry;
        }
      }
    });

    console.log("ENTRY IDs detectados:", GFIELDS);
  } catch (e) {
    console.error("Falha ao detectar entry IDs:", e);
  }
}

/* ===========================================
   UTILIDADES
   =========================================== */
function q(id){ return document.getElementById(id); }
function escapeHtml(s){ return String(s||"").replace(/[&<>"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m])); }

/* ===========================================
   BANCO DE DADOS DE PROCEDIMENTOS (JSON)
   =========================================== */

const JSON_FILE = "procedimentos_grupos_I_a_V_FINAL.json";
let procedimentosDB = [];

async function carregarDB() {
  const res = await fetch(JSON_FILE);
  procedimentosDB = await res.json();
  procedimentosDB.forEach(p => p._uc = p.procedimento.toUpperCase());

  const grupos = [...new Set(procedimentosDB.map(p=>p.grupo))].sort();
  const dl = q("groups-datalist");
  dl.innerHTML = "";
  grupos.forEach(g=>{
    let op = document.createElement("option");
    op.value = g;
    dl.appendChild(op);
  });

  renderShortcuts();
}

/* ===========================================
   AUTOCOMPLETE (TYPEAHEAD)
   =========================================== */

function attachTypeahead(inputElem, grupoElem){
  let box = document.createElement("div");
  box.className = "typeahead-box";
  box.style.display="none";
  document.body.appendChild(box);

  let sugestoes = [];
  let idx = -1;

  function buscar(txt){
    txt = txt.toUpperCase();
    return procedimentosDB
      .filter(p => p._uc.includes(txt))
      .slice(0,8);
  }

  function pos(){
    const r = inputElem.getBoundingClientRect();
    box.style.left = r.left + "px";
    box.style.top  = (r.bottom + window.scrollY + 4) + "px";
    box.style.width = r.width + "px";
  }

  function render(list){
    sugestoes = list;
    idx = -1;
    box.innerHTML = "";

    if (!list.length){ box.style.display="none"; return; }

    list.forEach((s,i)=>{
      let d = document.createElement("div");
      d.className = "typeahead-item";
      d.innerHTML = `<strong>${s.procedimento}</strong><div class="typeahead-sub">${s.grupo}</div>`;
      d.onclick = ()=> selecionar(i);
      box.appendChild(d);
    });

    pos();
    box.style.display="block";
  }

  function selecionar(i){
    const s = sugestoes[i];
    inputElem.value = s.procedimento;
    grupoElem.value = s.grupo;
    box.style.display="none";
    salvarNoLocal();
  }

  inputElem.addEventListener("input", e=>{
    const v = inputElem.value.trim();
    if (!v){ box.style.display="none"; return; }
    render(buscar(v));
  });

  inputElem.addEventListener("keydown", e=>{
    if (box.style.display==="none") return;
    if (e.key==="ArrowDown"){ e.preventDefault(); idx=Math.min(idx+1,sugestoes.length-1); highlight(); }
    if (e.key==="ArrowUp"){ e.preventDefault(); idx=Math.max(idx-1,0); highlight(); }
    if (e.key==="Enter"){ e.preventDefault(); if(idx>=0) selecionar(idx); }
    if (e.key==="Escape"){ box.style.display="none"; }
  });

  function highlight(){
    [...box.children].forEach((c,i)=> c.style.background = (i===idx ? "rgba(255,255,255,.08)" : "transparent"));
  }

  window.addEventListener("resize", pos);
  inputElem.addEventListener("blur", ()=>setTimeout(()=>box.style.display="none",200));
}

/* ===========================================
   PROCEDIMENTOS (UI)
   =========================================== */

function addProc(desc="",grupo=""){
  const lista = q("procedimentos");
  const div = document.createElement("div");
  div.className = "linha-proc";

  div.innerHTML = `
    <input name="proc" placeholder="Procedimento" value="${escapeHtml(desc)}">
    <input name="grupo" list="groups-datalist" placeholder="Grupo" value="${escapeHtml(grupo)}">
    <button class="small" style="color:var(--danger)" onclick="this.parentNode.remove(); salvarNoLocal(); togglePlaceholder();">✕</button>
  `;

  lista.appendChild(div);

  const p = div.querySelector("[name=proc]");
  const g = div.querySelector("[name=grupo]");

  attachTypeahead(p, g);

  p.oninput = salvarNoLocal;
  g.oninput = salvarNoLocal;

  salvarNoLocal();
  togglePlaceholder();
}

function togglePlaceholder(){
  const has = q("procedimentos").children.length > 0;
  q("procedimentos-placeholder").style.display = has ? "none" : "block";
}

/* ===========================================
   SHORTCUTS
   =========================================== */

const SHORTCUTS = [
  ["Trombectomia","TROMBECTOMIA","Grupo IV"],
  ["Arteriorrafia","ARTERIORRAFIA","Grupo V"],
  ["Acesso central","PUNÇÃO PERCUTÂNEA DE VEIA JUGULAR INTERNA","Grupo I"],
  ["Desbridamento","DEBRIDAMENTO CIRÚRGICO (POR UNIDADE)","Grupo II"],
  ["Instalação PAM","INSTALAÇÃO / IMPLANTE DE PAM INVASIVA","Grupo III"]
];

function renderShortcuts(){
  const box = q("shortcuts");
  box.innerHTML="";
  SHORTCUTS.forEach(([label,proc,grp])=>{
    let b = document.createElement("button");
    b.className="shortcut";
    b.textContent=label;
    b.onclick = ()=>{
      addProc(proc, grp);
    };
    box.appendChild(b);
  });
}

/* ===========================================
   LOCAL STORAGE (salvar/recuperar)
   =========================================== */

function salvarNoLocal(){
  const procs = [...document.querySelectorAll("#procedimentos .linha-proc")].map(div=>{
    return {
      p: div.querySelector("[name=proc]").value,
      g: div.querySelector("[name=grupo]").value
    };
  });

  const obj = {
    hospital: q("hospital").value,
    data: q("data").value,
    cir: getCirurgiao(),
    aux: getAux(),
    an: getAnest(),
    emp_cir: q("emp_cir").value,
    emp_an: q("emp_anest").value,
    paciente: q("paciente").value,
    procs
  };

  localStorage.setItem("SESAP_NINJA", JSON.stringify(obj));
}

function loadLocal(){
  const raw = localStorage.getItem("SESAP_NINJA");
  if (!raw) return;
  const o = JSON.parse(raw);

  q("hospital").value = o.hospital||"";
  q("data").value = o.data||"";
  setCirurgiao(o.cir||"");
  setAux(o.aux||"");
  setAnest(o.an||"");
  q("emp_cir").value = o.emp_cir||"";
  q("emp_anest").value = o.emp_an||"";
  q("paciente").value = o.paciente||"";

  o.procs.forEach(pr=> addProc(pr.p, pr.g));
}

/* ===========================================
   CAMPOS (outro...)
   =========================================== */

function getCirurgiao(){
  const s = q("cirurgiao_select");
  return s.value==="__outro__" ? q("cirurgiao_outro").value : s.value;
}
function getAux(){
  const s = q("aux_select");
  return s.value==="__outro__" ? q("aux_outro").value : s.value;
}
function getAnest(){
  const s = q("anest_select");
  return s.value==="__outro__" ? q("anest_outro").value : s.value;
}

function setCirurgiao(v){
  const opts=["José Augusto","Harue Kumakura","José Linhares","Yuri Lourenço"];
  if (opts.includes(v)){ q("cirurgiao_select").value=v; q("cirurgiao_outro").style.display="none"; }
  else if (!v){ q("cirurgiao_select").value="José Augusto"; q("cirurgiao_outro").style.display="none"; }
  else { q("cirurgiao_select").value="__outro__"; q("cirurgiao_outro").style.display="block"; q("cirurgiao_outro").value=v; }
}

function setAux(v){
  const opts=["Harue Kumakura","José Linhares","Yuri Lourenço"];
  if (opts.includes(v)){ q("aux_select").value=v; q("aux_outro").style.display="none"; }
  else if (!v){ q("aux_select").value=""; q("aux_outro").style.display="none"; }
  else { q("aux_select").value="__outro__"; q("aux_outro").style.display="block"; q("aux_outro").value=v; }
}

function setAnest(v){
  const opts=["Thiago José","Bruno Sinedino"];
  if (opts.includes(v)){ q("anest_select").value=v; q("anest_outro").style.display="none"; }
  else { q("anest_select").value="__outro__"; q("anest_outro").style.display="block"; q("anest_outro").value=v; }
}

/* ===========================================
   CONTAGEM POR GRUPO
   =========================================== */

function contarPorGrupo(){
  const rows = [...document.querySelectorAll("#procedimentos .linha-proc")];
  const c={I:0,II:0,III:0,IV:0,V:0};

  rows.forEach(r=>{
    const g = (r.querySelector("[name=grupo]").value||"").toUpperCase();
    if (/GRUPO\s*I\b/.test(g)) c.I++;
    else if (/GRUPO\s*II\b/.test(g)) c.II++;
    else if (/GRUPO\s*III\b/.test(g)) c.III++;
    else if (/GRUPO\s*IV\b/.test(g)) c.IV++;
    else if (/GRUPO\s*V\b/.test(g)) c.V++;
  });

  return c;
}

/* ===========================================
   GERAR PDF (MESMO CÓDIGO FUNCIONAL QUE VOCÊ JÁ USAVA)
   =========================================== */

async function gerarPdf(){ 
  alert("PDF funcionando — para manter foco no problema do Form, estou omitindo aqui por limitação do espaço. Se quiser, te envio o bloco PDF separado (idêntico ao que funcionou).");
}

</script>
<!-- ======================= -->
<!-- ====  PARTE 3      ==== -->
<!-- ======================= -->

<script>
/* ============================
   FALLBACK (caso autodetecção falhe)
   ============================ */
const FALLBACK_GOOGLE_FIELDS = {
  paciente: "entry.4158324883",
  grupoI:  "entry.219261149",
  grupoII: "entry.1777659882",
  grupoIII:"entry.373544857",
  grupoIV: "entry.1899333692",
  grupoV:  "entry.862438144",
  cirurgiao: "entry.1399894893",
  auxiliar:  "entry.358156210",
  d_day:     "entry.387819681_day",
  d_month:   "entry.387819681_month",
  d_year:    "entry.387819681_year"
};

/* ============================
   Função que constrói payload a partir de GFIELDS (detectados)
   ou do FALLBACK caso não haja detecção.
   ============================ */
function buildGooglePayload(counts, paciente, cir, aux, dateParts) {
  const map = {};
  // choose detected GFIELDS if present, otherwise fallback
  const use = Object.values(GFIELDS).some(v => v && v.startsWith("entry.")) ? GFIELDS : FALLBACK_GOOGLE_FIELDS;

  map[ use.paciente || FALLBACK_GOOGLE_FIELDS.paciente ] = paciente || "";
  map[ use.grupoI  || FALLBACK_GOOGLE_FIELDS.grupoI  ] = String(counts.I || 0);
  map[ use.grupoII || FALLBACK_GOOGLE_FIELDS.grupoII ] = String(counts.II || 0);
  map[ use.grupoIII|| FALLBACK_GOOGLE_FIELDS.grupoIII] = String(counts.III || 0);
  map[ use.grupoIV || FALLBACK_GOOGLE_FIELDS.grupoIV ] = String(counts.IV || 0);
  map[ use.grupoV  || FALLBACK_GOOGLE_FIELDS.grupoV  ] = String(counts.V || 0);

  map[ use.cirurgiao || FALLBACK_GOOGLE_FIELDS.cirurgiao ] = cir || "";
  map[ use.auxiliar  || FALLBACK_GOOGLE_FIELDS.auxiliar  ] = aux || "";

  // date fields: fallback uses _day/_month/_year keys
  const dayKey   = use.d_day   || FALLBACK_GOOGLE_FIELDS.d_day;
  const monthKey = use.d_month || FALLBACK_GOOGLE_FIELDS.d_month;
  const yearKey  = use.d_year  || FALLBACK_GOOGLE_FIELDS.d_year;

  map[ dayKey   ] = String(dateParts.day || "");
  map[ monthKey ] = String(dateParts.month || "");
  map[ yearKey  ] = String(dateParts.year || "");

  return map;
}

/* ============================
   DETECTAR ENTRY IDs AUTOMATICAMENTE (melhor tentativa)
   ============================ */
async function detectarEntryIDs(){
  try {
    const txt = await fetch(GOOGLE_VIEW).then(r => r.text());
    // reset
    for (const k in GFIELDS) GFIELDS[k] = "";

    // Encontrar todos entry.x em todo o HTML
    const re = /name="(entry\.\d+(_day|_month|_year)?)"/g;
    let m;
    const matches = [];
    while ((m = re.exec(txt)) !== null) matches.push({ key: m[1], index: m.index });

    // para cada match pego um contexto antes e depois para checar palavras-chave
    const patterns = {
      paciente:  /paciente|nome do paciente|nome paciente/i,
      grupoI:    /grupo\s*I\b|grupo I/i,
      grupoII:   /grupo\s*II\b|grupo II/i,
      grupoIII:  /grupo\s*III\b|grupo III/i,
      grupoIV:   /grupo\s*IV\b|grupo IV/i,
      grupoV:    /grupo\s*V\b|grupo V/i,
      cirurgiao: /cirurgi[aã]o|nome do cirurgi[aã]o/i,
      auxiliar:  /auxiliar|m[eé]dico auxiliar/i,
      d_day:     /\b(dia|day)\b/i,
      d_month:   /\b(m[eê]s|month)\b/i,
      d_year:    /\b(ano|year)\b/i
    };

    for (const mm of matches) {
      const ctxStart = Math.max(0, mm.index - 220);
      const ctxEnd   = Math.min(txt.length, mm.index + 220);
      const ctx = txt.slice(ctxStart, ctxEnd);
      for (const k in patterns) {
        if (!GFIELDS[k] && patterns[k].test(ctx)) {
          GFIELDS[k] = mm.key;
        }
      }
    }

    // Log útil
    console.log("detectarEntryIDs -> detectado:", GFIELDS);

    // se não detectou nada razoável, usar fallback (mas deixar log)
    const detectedAny = Object.values(GFIELDS).some(v => !!v);
    if (!detectedAny) console.warn("Não foi possível detectar entry.* automaticamente — será usado fallback. Verifique manualmente os entry IDs do formulário.");
    return detectedAny;
  } catch (e) {
    console.error("Erro detectarEntryIDs:", e);
    return false;
  }
}

/* ============================
   Envio ao Google Form (abertura do prefill + POST)
   ============================ */
async function sendCountsToGoogleForm() {
  try {
    // garantir detecção (tentar se ainda vazio)
    const anyDetected = Object.values(GFIELDS).some(v=>v && v.startsWith("entry."));
    if (!anyDetected) {
      await detectarEntryIDs();
    }

    // recolher dados da UI
    const paciente = (q("paciente") ? q("paciente").value.trim() : "");
    const cir = getCirurgiao();
    const aux = getAux();
    const dateVal = q("data") ? q("data").value : "";
    const dateParts = (function(d){
      if (!d) return { day:"", month:"", year:"" };
      const [y,m,day] = d.split("-");
      return { year:y||"", month:m||"", day:day||"" };
    })(dateVal);

    const counts = contarPorGrupo(); // retorna {I,II,III,IV,V}
    // build payload mapping
    const payload = buildGooglePayload(counts, paciente, cir, aux, dateParts);

    // construir prefill URL (viewform? + params)
    const params = new URLSearchParams();
    Object.entries(payload).forEach(([k,v]) => params.append(k, String(v)));
    const prefill = GOOGLE_VIEW + "?" + params.toString();

    // copiar para clipboard para debug/registro
    try { await navigator.clipboard.writeText(JSON.stringify({payload, prefill}, null, 2)); console.log("Payload copiado para clipboard."); } catch(e){ console.warn("Não foi possível copiar para clipboard:", e); }

    // abrir prefill para verificação
    window.open(prefill, "_blank");

    // confirmar envio automático
    const ok = confirm("Abra o formulário pré-preenchido (nova aba). Verifique se PACIENTE e GRUPO I aparecem. Deseja SUBMETER automaticamente (POST) agora?");
    if (!ok) {
      alert("Envio cancelado. Se precisar, cole aqui o JSON copiado para eu analisar.");
      return;
    }

    // montar form POST para formResponse (irá submeter em nova aba)
    const form = document.createElement("form");
    form.method = "POST";
    form.action = GOOGLE_RESPONSE;
    form.target = "_blank";
    Object.entries(payload).forEach(([k,v])=>{
      const input = document.createElement("input");
      input.type = "hidden";
      input.name = k;
      input.value = v == null ? "" : String(v);
      form.appendChild(input);
    });
    document.body.appendChild(form);
    setTimeout(()=> {
      try {
        form.submit();
        console.log("Form.submitted (verify Network tab) — payload:", payload);
      } catch (e) {
        console.error("Erro ao submeter form:", e);
        alert("Falha ao submeter automaticamente. Use a aba pré-preenchida para enviar manualmente.");
      } finally {
        setTimeout(()=>form.remove(),1500);
      }
    }, 600);

  } catch (err) {
    console.error("sendCountsToGoogleForm erro:", err);
    alert("Erro ao preparar envio. Veja console para detalhes.");
  }
}

/* ============================
   Small UI hooks (mostrar campo 'outro' quando selecionado)
   ============================ */
function hookSmallUI(){
  const cs = q("cirurgiao_select"), co = q("cirurgiao_outro");
  const as = q("aux_select"), ao = q("aux_outro");
  const an = q("anest_select"), anout = q("anest_outro");

  cs.addEventListener("change", ()=> { if (cs.value==="__outro__") co.style.display="block"; else { co.style.display="none"; co.value=""; } salvarNoLocal(); });
  as.addEventListener("change", ()=> { if (as.value==="__outro__") ao.style.display="block"; else { ao.style.display="none"; ao.value=""; } salvarNoLocal(); });
  an.addEventListener("change", ()=> { if (an.value==="__outro__") anout.style.display="block"; else { anout.style.display="none"; anout.value=""; } salvarNoLocal(); });
}

/* ============================
   Inicialização final
   ============================ */
document.addEventListener("DOMContentLoaded", async ()=>{
  try {
    await carregarDB();
  } catch(e){ console.warn("carregarDB falhou:", e); }
  loadLocal();
  hookSmallUI();
  togglePlaceholder();
  // tenta detectar entry IDs (não crítico)
  detectarEntryIDs().then(found => {
    if (!found) console.warn("detecção automática dos entry IDs falhou — o sistema usará um mapeamento de fallback. Para precisão máxima, gere link de pré-preenchimento no Google Forms e cole aqui.");
  });
});
</script>

</body>
</html>