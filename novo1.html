<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gerar Faturamento SESAP</title>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 900px; margin: 20px auto; }
    label { display:block; margin-top:10px; font-weight:bold; }
    input { width:100%; padding:6px; margin-top:4px; box-sizing:border-box; }
    .linha-proc { display:flex; gap:10px; margin-top:8px; }
    .linha-proc input { width:100%; }
    button { margin-top:15px; padding:8px 16px; cursor:pointer; }
  </style>
</head>
<body>
  <h1>Faturamento de Cirurgias Eletivas (SESAP)</h1>

  <form onsubmit="event.preventDefault(); gerarPdf();">
    <label>Hospital
      <input id="hospital" value="HOSPITAL RIO GRANDE">
    </label>

    <label>Data
      <input id="data" type="date">
    </label>

    <label>Nome do cirurgião
      <input id="cirurgiao" value="José Augusto">
    </label>

    <label>Nome do médico auxiliar
      <input id="auxiliar">
    </label>

    <label>Nome do anestesista
      <input id="anest" value="Thiago José">
    </label>

    <label>Empresa do cirurgião
      <input id="emp_cir" value="Targino & Rocha">
    </label>

    <label>Empresa do anestesista
      <input id="emp_anest" value="COOPANEST RN">
    </label>

    <label>Nome do paciente
      <input id="paciente">
    </label>

    <h2>Procedimentos</h2>
    <p>Informe todos os procedimentos (máx. 5 por página; o script cria as páginas necessárias).</p>

    <div id="procedimentos">
      <div class="linha-proc">
        <input name="procedimento" placeholder="Descrição do procedimento">
        <input name="grupo" placeholder="Grupo do procedimento">
      </div>
    </div>

    <button type="button" onclick="addProc()">+ Adicionar procedimento</button>
    <br>
    <button type="submit">Gerar PDF</button>
  </form>

  <script>
    // Preenche a data de hoje no input date
    document.addEventListener("DOMContentLoaded", () => {
      const hoje = new Date();
      const yyyy = hoje.getFullYear();
      const mm = String(hoje.getMonth() + 1).padStart(2, "0");
      const dd = String(hoje.getDate()).padStart(2, "0");
      document.getElementById("data").value = `${yyyy}-${mm}-${dd}`;
    });

    function addProc() {
      const div = document.createElement('div');
      div.className = 'linha-proc';
      div.innerHTML = `
        <input name="procedimento" placeholder="Descrição do procedimento">
        <input name="grupo" placeholder="Grupo do procedimento">
      `;
      document.getElementById('procedimentos').appendChild(div);
    }

    function dividirEmBlocos(lista, tamanho) {
      const blocos = [];
      for (let i = 0; i < lista.length; i += tamanho) {
        blocos.push(lista.slice(i, i + tamanho));
      }
      return blocos;
    }

    async function gerarPdf() {
      const { PDFDocument } = PDFLib;

      // Coleta dados do formulário
      const hospital   = document.getElementById("hospital").value || "";
      const dataInput  = document.getElementById("data").value;
      const cirurgiao  = document.getElementById("cirurgiao").value || "";
      const auxiliar   = document.getElementById("auxiliar").value || "";
      const anest      = document.getElementById("anest").value || "";
      const emp_cir    = document.getElementById("emp_cir").value || "";
      const emp_anest  = document.getElementById("emp_anest").value || "";
      const paciente   = document.getElementById("paciente").value || "";

      // Data em DD/MM/AAAA para o PDF (se quiser manter AAAA-MM-DD, é só usar dataInput direto)
      let dataStr = "";
      if (dataInput) {
        const [yyyy, mm, dd] = dataInput.split("-");
        dataStr = `${dd}/${mm}/${yyyy}`;
      }

      // EQUIPE MÉDICA
      const equipeTexto = `Cirurgião: ${cirurgiao} / Auxiliar: ${auxiliar} / Anest.: ${anest}`;

      // Pega lista de procedimentos
      const linhas = document.querySelectorAll("#procedimentos .linha-proc");
      const procedimentos = [];
      linhas.forEach(linha => {
        const descricao = linha.querySelector('input[name="procedimento"]').value.trim();
        const grupo = linha.querySelector('input[name="grupo"]').value.trim();
        if (descricao) {
          procedimentos.push({ descricao, grupo });
        }
      });

      if (procedimentos.length === 0) {
        alert("Informe pelo menos 1 procedimento.");
        return;
      }

      // Carrega o template uma única vez
      const templateBytes = await fetch("sesap.pdf").then(res => res.arrayBuffer());

      // Documento final
      const docFinal = await PDFDocument.create();

      // Função que cria e adiciona uma página (tipo 'cirurgia' ou 'anestesia')
      async function adicionarPagina(tipo, bloco) {
        const tempDoc = await PDFDocument.load(templateBytes);
        const form = tempDoc.getForm();

        // Campos gerais
        form.getTextField("HOSPITAL").setText(hospital);
        form.getTextField("DATA").setText(dataStr);
        form.getTextField("EQUIPE").setText(equipeTexto);

        if (tipo === "cirurgia") {
          form.getTextField("EMPRESA").setText(emp_cir);
        } else { // anestesia
          form.getTextField("EMPRESA").setText(emp_anest);
        }

        // Preenche até 5 linhas por página
        for (let i = 0; i < 5; i++) {
          const linha = bloco[i];
          const idx = i + 1;
          const sufDois = String(idx).padStart(2, "0"); // 01,02,...

          const campoProc = form.getTextField(`PROCEDIMENTO_${sufDois}`);
          const campoPac  = form.getTextField(`PACIENTE${sufDois}`);
          const campoGrupo = form.getTextField(`GRUPOP${idx}`);
          const campoMedPrinc = form.getTextField(`MEDICO_PRINC_${sufDois}`);
          const campoMedAux   = form.getTextField(`MEDICO_AUX_${sufDois}`);

          if (linha) {
            campoProc.setText(linha.descricao);
            campoPac.setText(paciente);
            campoGrupo.setText(linha.grupo || "");

            if (tipo === "cirurgia") {
              campoMedPrinc.setText(cirurgiao);
              campoMedAux.setText(auxiliar);
            } else {
              campoMedPrinc.setText(anest);
              campoMedAux.setText(""); // auxiliar em branco
            }
          } else {
            // Deixa em branco se não tiver procedimento nessa linha
            campoProc.setText("");
            campoPac.setText("");
            campoGrupo.setText("");
            campoMedPrinc.setText("");
            campoMedAux.setText("");
          }
        }

        // Torna campos estáticos (opcional)
        form.flatten();

        const [pagina] = await docFinal.copyPages(tempDoc, [0]);
        docFinal.addPage(pagina);
      }

      // Divide os procedimentos em blocos de 5 e cria as páginas
      const blocos = dividirEmBlocos(procedimentos, 5);
      for (const bloco of blocos) {
        await adicionarPagina("cirurgia", bloco); // página da equipe cirúrgica
        await adicionarPagina("anestesia", bloco); // página do anestesista
      }

      const pdfBytes = await docFinal.save();

      // Download do PDF
      const blob = new Blob([pdfBytes], { type: "application/pdf" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "faturamento_sesap.pdf";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
