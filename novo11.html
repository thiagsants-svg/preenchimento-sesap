<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SESAP Ninja — Gerador de Faturamento</title>
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

<style>
  :root{
    --bg:#0b1220; --card:#071428; --muted:#97a6bf; --text:#e6eef8;
    --accent:#06b6d4; --accent-2:#7c3aed; --danger:#ff6b6b;
    --radius:12px; --shadow: 0 10px 30px rgba(2,6,23,0.65);
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#030514 0%,var(--bg) 100%); color:var(--text);font-family:Inter,system-ui,Arial;}
  .wrap{max-width:1150px;margin:20px auto;padding:18px;}
  header{display:flex;gap:12px;align-items:center;margin-bottom:18px}
  .badge{width:64px;height:64px;border-radius:14px;background:linear-gradient(135deg,var(--accent-2),#0ea5a3);display:flex;align-items:center;justify-content:center;color:white;font-weight:800;box-shadow:var(--shadow)}
  h1{margin:0;font-size:1.1rem}
  p.lead{margin:4px 0 0;color:var(--muted);font-size:0.92rem}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }
  .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:var(--shadow)}
  label{display:block;font-weight:700;margin-bottom:6px;color:var(--text);font-size:0.88rem}
  input[type="text"], input[type="date"], select{
    width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);font-size:0.95rem;box-sizing:border-box;
  }
  input::placeholder{color:rgba(230,238,248,0.28)}
  /* ===================== FIX: styled selects & options ===================== */
  select{
    -webkit-appearance: none; -moz-appearance: none; appearance: none;
    background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.007));
    color:var(--text);
    padding-right: 28px; /* room for pseudo arrow */
    position:relative;
  }
  /* small custom arrow */
  select::-ms-expand { display: none; } /* remove IE arrow */
  select.custom-arrow { background-image: none; }
  /* attempt to restyle options (honored by many browsers) */
  option{ background: var(--card); color: var(--text); }
  /* add a simple pseudo-arrow with :after on container */
  .select-wrap{position:relative}
  .select-wrap:after{
    content:'▾'; position:absolute; right:10px; top:50%; transform:translateY(-50%); color:var(--muted); pointer-events:none;
  }
  /* ======================================================================== */

  .row{display:flex;gap:12px}
  .row .col{flex:1}
  /* procedimentos UI */
  #procedimentos{display:flex;flex-direction:column;gap:10px;max-height:420px;overflow:auto;padding-right:6px;margin-top:10px}
  .linha-proc{display:grid;grid-template-columns:1fr 200px 44px;gap:10px;align-items:center;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03)}
  .linha-proc input, .linha-proc select{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text)}
  .proc-actions{display:flex;flex-direction:column;gap:6px;align-items:center}
  .btn{padding:10px 14px;border-radius:12px;border:0;cursor:pointer;font-weight:700}
  .btn.primary{background:linear-gradient(90deg,var(--accent-2),var(--accent));color:#02101a}
  .small{padding:8px 10px;border-radius:10px;border:0;background:transparent;color:var(--accent);font-weight:700}
  .muted{color:var(--muted);font-size:0.9rem}

  /* ==================== AUX "OUTRO" HIGHLIGHT (melhora visibilidade) ==================== */
  .aux-other { display:none; margin-top:6px; }
  .aux-other input, #cirurgiao_outro, #anest_outro {
    width:100%; padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.06);
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); color:var(--text); font-size:0.95rem;
    box-shadow: 0 6px 18px rgba(2,6,23,0.5);
    transition: box-shadow .12s ease, border-color .12s ease, transform .06s ease;
  }
  .aux-other input:focus, #cirurgiao_outro:focus, #anest_outro:focus{
    outline: none; border-color: var(--accent); box-shadow: 0 8px 26px rgba(6,182,212,0.12); transform: translateY(-1px);
  }
  /* small visible label for other inputs */
  .aux-label{ font-size:0.78rem; color:var(--muted); margin-bottom:6px; display:block; }

  /* helper: ensure select text remains readable on focus */
  select:focus{ outline:none; box-shadow:0 8px 22px rgba(7,20,40,0.35); border-color: rgba(124,58,237,0.5); }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="badge" title="SESAP Ninja">
        <!-- simplistic SVG icon kept as fallback -->
        <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" width="42" height="42" fill="none">
          <circle cx="32" cy="32" r="30" fill="#0f1724"/>
          <path d="M12 34c6 0 12-8 20-8s14 8 20 8" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <div style="flex:1">
        <h1>SESAP Ninja — Gerador de Faturamento</h1>
        <p class="lead">Preencha rápido com autocomplete e atalhos ninja.</p>
      </div>
      <!-- REMOVED theme toggle as requested -->
    </header>

    <div class="grid">
      <div>
        <div class="card">
          <div style="display:flex;gap:12px;flex-direction:column">

            <div class="row">
              <div class="col">
                <label>Hospital</label>
                <input id="hospital" type="text" value="HOSPITAL RIO GRANDE">
              </div>
              <div style="width:190px">
                <label>Data</label>
                <input id="data" type="date">
              </div>
            </div>

            <!-- CIRURGIÃO / AUXILIAR / ANESTESISTA -->
            <div class="row" style="margin-top:8px">
              <div class="col">
                <label>Cirurgião</label>
                <div class="select-wrap">
                  <select id="cirurgiao_select" class="custom-arrow">
                    <option value="José Augusto">José Augusto</option>
                    <option value="Harue Kumakura">Harue Kumakura</option>
                    <option value="José Linhares">José Linhares</option>
                    <option value="Yuri Lourenço">Yuri Lourenço</option>
                    <option value="__outro__">Outro...</option>
                  </select>
                </div>
                <div class="aux-other" id="cirurgiao-other" style="margin-top:8px">
                  <span class="aux-label">Outro cirurgião</span>
                  <input id="cirurgiao_outro" placeholder="Digite o nome do cirurgião">
                </div>
              </div>

              <div class="col">
                <label>Auxiliar</label>
                <div class="select-wrap">
                  <select id="aux_select" class="custom-arrow">
                    <option value="">-- selecionar --</option>
                    <option value="Harue Kumakura">Harue Kumakura</option>
                    <option value="José Linhares">José Linhares</option>
                    <option value="Yuri Lourenço">Yuri Lourenço</option>
                    <option value="__outro__">Outro...</option>
                  </select>
                </div>
                <div class="aux-other" id="aux-other" style="margin-top:8px">
                  <span class="aux-label">Outro auxiliar</span>
                  <input id="aux_outro" placeholder="Digite o nome do auxiliar (visual amplo)">
                </div>
              </div>
            </div>

            <div class="row" style="margin-top:8px">
              <div class="col">
                <label>Anestesista</label>
                <div class="select-wrap">
                  <select id="anest_select" class="custom-arrow">
                    <option value="Thiago José">Thiago José</option>
                    <option value="Bruno Sinedino">Bruno Sinedino</option>
                    <option value="__outro__">Outro...</option>
                  </select>
                </div>
                <div class="aux-other" id="anest-other" style="margin-top:8px">
                  <span class="aux-label">Outro anestesista</span>
                  <input id="anest_outro" placeholder="Digite o nome do anestesista">
                </div>
              </div>

              <div class="col">
                <label>Empresa do cirurgião</label>
                <input id="emp_cir" type="text" value="Targino & Rocha">
              </div>
            </div>

            <div class="row" style="margin-top:8px">
              <div class="col">
                <label>Empresa do anestesista</label>
                <input id="emp_anest" type="text" value="COOPANEST RN">
              </div>
              <div class="col">
                <label>Paciente</label>
                <input id="paciente" type="text" placeholder="Nome completo do paciente">
              </div>
            </div>

            <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.04)" />

            <!-- procedimentos... (mantive a mesma lógica que você já usa) -->
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <strong>Procedimentos</strong>
                <div class="muted" style="margin-top:6px;font-size:0.9rem">Atalhos rápidos abaixo — arraste para reordenar</div>
              </div>
              <div style="display:flex;gap:8px">
                <button type="button" class="small" onclick="duplicarUltima()">Duplicar</button>
                <button type="button" class="small" onclick="addProc()">Adicionar</button>
                <button type="button" class="small" style="background:transparent;color:var(--danger);" onclick="limparProcedimentos()">Limpar</button>
              </div>
            </div>

            <div id="shortcuts" class="shortcuts" style="margin-top:10px"></div>
            <datalist id="groups-datalist"></datalist>
            <div id="procedimentos"></div>

            <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap">
              <button class="btn primary" onclick="gerarPdf({preview:true})">Pré-visualizar PDF</button>
              <button class="btn" onclick="gerarPdf({preview:false})" style="background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.04)">Gerar e baixar</button>
              <button class="btn" style="background:transparent;color:var(--accent);border:0" onclick="salvarManualmente()">Salvar</button>
              <button class="btn" style="background:transparent;color:var(--danger)" onclick="limparTudo()">Resetar tudo</button>
            </div>

            <div class="muted" style="margin-top:10px">Dados salvos localmente (localStorage). JSON: <code>procedimentos_grupos_I_a_V_FINAL.json</code>.</div>
          </div>
        </div>
      </div>

      <!-- side card summary -->
      <div>
        <div class="card" style="position:sticky;top:20px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Resumo</strong><div class="muted" style="font-size:0.9rem">Confira antes de gerar</div></div>
            <div style="text-align:right"><span id="count-proc">0</span> itens</div>
          </div>

          <div style="margin-top:12px">
            <div style="padding:10px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border:1px solid rgba(255,255,255,0.03)">
              <div style="font-weight:700">Equipe</div>
              <div class="muted" id="preview-equipe">—</div>
            </div>
            <div style="height:10px"></div>
            <div style="padding:10px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border:1px solid rgba(255,255,255,0.03)">
              <div style="font-weight:700">Hospital / Data</div>
              <div class="muted" id="preview-hospital">—</div>
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="small" onclick="salvarManualmente()">Salvar</button>
            <button class="small" onclick="location.reload()">Recarregar</button>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="card">
          <div style="font-weight:700;margin-bottom:6px">Ajuda rápida</div>
          <div class="muted">• Use atalhos para inserir rapidamente.<br>• Reordene arrastando.<br>• Cada 5 procedimentos geram 2 páginas (Cirurgia + Anestesia).</div>
        </div>
      </div>
    </div>

    <footer style="text-align:center;margin-top:18px;color:var(--muted)">SESAP Ninja — interface dark • mantenha <code>sesap.pdf</code> e o JSON na mesma pasta.</footer>
  </div>

<script>
/* Mantive a maior parte da lógica anterior — aqui apenas incluo as partes
   que controlam a exibição dos campos "Outro" com foco/seleção e o carregamento da storage.
   O restante (carregar JSON, typeahead, gerarPdf) você já tem funcionando:
   apenas certifique-se de colar suas funções anteriores (carregarDB, attachTypeahead, etc.)
   ou me peça que eu integre tudo se preferir.
*/

const STORAGE_KEY = "sesap_ninja_v1";

/* helper */
function q(id){ return document.getElementById(id); }

/* show/hide & focus for 'Outro' fields (cirurgiao, aux, anest) */
function hookOutroFields() {
  const cirSel = q("cirurgiao_select"), cirOtherWrap = q("cirurgiao-other"), cirOther = q("cirurgiao_outro");
  const auxSel = q("aux_select"), auxOtherWrap = q("aux-other"), auxOther = q("aux_outro");
  const anSel = q("anest_select"), anOtherWrap = q("anest-other"), anOther = q("anest_outro");

  function handle(sel, wrap, other) {
    sel.addEventListener("change", ()=>{
      if (sel.value === "__outro__") {
        wrap.style.display = "block";
        // tiny timeout to ensure visible before focus/select
        setTimeout(()=>{ other.focus(); other.select(); }, 40);
      } else {
        wrap.style.display = "none"; other.value = "";
      }
      salvarNoLocalStorage();
      updateSidePreview();
    });
  }
  handle(cirSel, cirOtherWrap, cirOther);
  handle(auxSel, auxOtherWrap, auxOther);
  handle(anSel, anOtherWrap, anOther);

  // on load: if storage had __outro__, show and focus+select
  requestAnimationFrame(()=>{
    if (cirSel.value === "__outro__") { cirOtherWrap.style.display="block"; if (cirOther.value) { cirOther.focus(); cirOther.select(); } }
    if (auxSel.value === "__outro__") { auxOtherWrap.style.display="block"; if (auxOther.value) { auxOther.focus(); auxOther.select(); } }
    if (anSel.value === "__outro__") { anOtherWrap.style.display="block"; if (anOther.value) { anOther.focus(); anOther.select(); } }
  });

  // input listeners to save changes
  [cirOther, auxOther, anOther].forEach(el=>{
    el && el.addEventListener("input", ()=>{ salvarNoLocalStorage(); updateSidePreview(); });
  });
}

/* small stubs for storage functions so this snippet runs; replace with your full impl */
function salvarNoLocalStorage(){ /* sua implementação existente */ }
function updateSidePreview(){ /* sua implementação existente */ }

/* call hook after DOM ready */
document.addEventListener("DOMContentLoaded", ()=>{ hookOutroFields(); /* e o restante das funções de init */ });
</script>
</body>
</html>
