<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gerar Faturamento SESAP</title>

  <!-- pdf-lib -->
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 20px auto;
    }

    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }

    input {
      width: 100%;
      padding: 6px;
      margin-top: 4px;
      box-sizing: border-box;
    }

    .linha-proc {
      display: flex;
      gap: 10px;
      margin-top: 8px;
    }

    .linha-proc input {
      width: 100%;
    }

    button {
      margin-top: 15px;
      padding: 10px 20px;
      cursor: pointer;
      font-weight: bold;
    }
  </style>
</head>
<body>

<h1>Faturamento de Cirurgias Eletivas (SESAP)</h1>

<form onsubmit="event.preventDefault(); gerarPdf();">

  <label>Hospital
    <input id="hospital" value="HOSPITAL RIO GRANDE">
  </label>

  <label>Data
    <input id="data" type="date">
  </label>

  <label>Nome do cirurgião
    <input id="cirurgiao" value="José Augusto">
  </label>

  <label>Nome do médico auxiliar
    <input id="auxiliar" value="">
  </label>

  <label>Nome do anestesista
    <input id="anest" value="Thiago José">
  </label>

  <label>Empresa do cirurgião
    <input id="emp_cir" value="Targino & Rocha">
  </label>

  <label>Empresa do anestesista
    <input id="emp_anest" value="COOPANEST RN">
  </label>

  <label>Nome do paciente (é repetido automaticamente)
    <input id="paciente">
  </label>

  <h2>Procedimentos</h2>

  <div id="procedimentos">
    <div class="linha-proc">
      <input name="procedimento" placeholder="Descrição do procedimento">
      <input name="grupo" placeholder="Grupo do procedimento">
    </div>
  </div>

  <button type="button" onclick="addProc()">+ Adicionar procedimento</button><br>
  <button type="submit">Gerar PDF</button>

</form>

<script>
  // Preenche a data de hoje
  document.addEventListener("DOMContentLoaded", () => {
    const hoje = new Date();
    const yyyy = hoje.getFullYear();
    const mm = String(hoje.getMonth() + 1).padStart(2, "0");
    const dd = String(hoje.getDate()).padStart(2, "0");
    document.getElementById("data").value = `${yyyy}-${mm}-${dd}`;
  });

  function addProc() {
    const div = document.createElement("div");
    div.className = "linha-proc";
    div.innerHTML = `
      <input name="procedimento" placeholder="Descrição do procedimento">
      <input name="grupo" placeholder="Grupo do procedimento">
    `;
    document.getElementById("procedimentos").appendChild(div);
  }

  function dividirEmBlocos(lista, tamanho) {
    const blocos = [];
    for (let i = 0; i < lista.length; i += tamanho) {
      blocos.push(lista.slice(i, i + tamanho));
    }
    return blocos;
  }

  async function gerarPdf() {
    const { PDFDocument } = PDFLib;

    // Pega os valores dos inputs (sem shadowing)
    const hospitalVal  = document.getElementById("hospital").value;
    const dataInput    = document.getElementById("data").value;
    const cirurgiaoVal = document.getElementById("cirurgiao").value;
    const auxiliarVal  = document.getElementById("auxiliar").value;
    const anestVal     = document.getElementById("anest").value;
    const empCirVal    = document.getElementById("emp_cir").value;
    const empAnestVal  = document.getElementById("emp_anest").value;
    const pacienteVal  = document.getElementById("paciente").value;

    if (!pacienteVal) {
      alert("Informe o nome do paciente.");
      return;
    }

    // Formata data para DD/MM/AAAA
    let dataStr = "";
    if (dataInput) {
      const [yyyy, mm, dd] = dataInput.split("-");
      dataStr = `${dd}/${mm}/${yyyy}`;
    }

    // Texto da equipe
    const equipeTexto =
      `Cirurgião: ${cirurgiaoVal} / Auxiliar: ${auxiliarVal} / Anest.: ${anestVal}`;

    // Lista de procedimentos
    const linhas = document.querySelectorAll("#procedimentos .linha-proc");
    const procedimentos = [];
    linhas.forEach(linha => {
      const desc = linha.children[0].value.trim();
      const grupo = linha.children[1].value.trim();
      if (desc) procedimentos.push({ descricao: desc, grupo });
    });

    if (procedimentos.length === 0) {
      alert("Informe pelo menos um procedimento.");
      return;
    }

    const templateBytes = await fetch("sesap.pdf").then(r => r.arrayBuffer());
    const docFinal = await PDFDocument.create();

    async function adicionarPagina(tipo, bloco) {
      const tempDoc = await PDFDocument.load(templateBytes);
      const form = tempDoc.getForm();

      // Campos superiores
      const fHospital = form.getTextField("HOSPITAL");
      fHospital.setText(hospitalVal);
      fHospital.setFontSize(11);

      const fEmpresa = form.getTextField("EMPRESA");
      fEmpresa.setText(tipo === "cirurgia" ? empCirVal : empAnestVal);
      fEmpresa.setFontSize(11);

      const fData = form.getTextField("DATA");
      fData.setText(dataStr);
      fData.setFontSize(10);

      const fEquipe = form.getTextField("EQUIPE");
      fEquipe.setText(equipeTexto);
      fEquipe.setFontSize(9);

      for (let i = 0; i < 5; i++) {
        const linha = bloco[i];
        const idx = i + 1;
        const suf = String(idx).padStart(2, "0");

        const campoProc     = form.getTextField(`PROCEDIMENTO_${suf}`);
        const campoPac      = form.getTextField(`PACIENTE${suf}`);
        const campoGrupo    = form.getTextField(`GRUPOP${idx}`);
        const campoMedPrinc = form.getTextField(`MEDICO_PRINC_${suf}`);
        const campoMedAux   = form.getTextField(`MEDICO_AUX_${suf}`);

        // Multiline + tamanho adequado
        campoProc.enableMultiline();
        campoProc.setFontSize(9);
        campoPac.setFontSize(9);
        campoGrupo.setFontSize(9);
        campoMedPrinc.setFontSize(10);
        campoMedAux.setFontSize(10);

        if (linha) {
          campoProc.setText(linha.descricao);
          campoPac.setText(pacienteVal);
          campoGrupo.setText(linha.grupo || "");

          if (tipo === "cirurgia") {
            campoMedPrinc.setText(cirurgiaoVal);
            campoMedAux.setText(auxiliarVal);
          } else {
            campoMedPrinc.setText(anestVal);
            campoMedAux.setText("");
          }
        } else {
          campoProc.setText("");
          campoPac.setText("");
          campoGrupo.setText("");
          campoMedPrinc.setText("");
          campoMedAux.setText("");
        }
      }

      form.flatten();
      const [pagina] = await docFinal.copyPages(tempDoc, [0]);
      docFinal.addPage(pagina);
    }

    const blocos = dividirEmBlocos(procedimentos, 5);

    for (const bloco of blocos) {
      await adicionarPagina("cirurgia", bloco);
      await adicionarPagina("anestesia", bloco);
    }

    const pdfBytes = await docFinal.save();
    const blob = new Blob([pdfBytes], { type: "application/pdf" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "faturamento_sesap.pdf";
    a.click();
    URL.revokeObjectURL(url);
  }
</script>

</body>
</html>
