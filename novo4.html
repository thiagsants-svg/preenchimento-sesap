<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Faturamento de Cirurgias Eletivas (SESAP)</title>

  <!-- pdf-lib -->
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; max-width: 980px; margin: 18px auto; padding: 0 16px; }
    h1 { margin-bottom: 6px; }
    label { display:block; margin-top:12px; font-weight:700; }
    input[type="text"], input[type="date"] {
      width:100%; padding:8px; margin-top:6px; box-sizing:border-box; border:1px solid #bbb; border-radius:3px;
    }
    .h-row { display:flex; gap:10px; }
    .linha-proc { display:flex; gap:10px; margin-top:8px; align-items:center; padding:6px; border:1px dashed transparent; border-radius:4px; background:#fafafa; }
    .linha-proc.dragging { opacity:0.6; border-color:#888; background:#fffbe6; }
    .linha-proc input { width:100%; padding:6px; box-sizing:border-box; border:1px solid #ccc; border-radius:3px; }
    .proc-controls { display:flex; gap:8px; align-items:center; }
    button { margin-top:12px; padding:8px 12px; border-radius:4px; border:1px solid #888; background:#f3f3f3; cursor:pointer; font-weight:700; }
    .small { padding:6px 8px; font-weight:600; }
    .controls-line { display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
    .muted { color:#666; font-size:0.9em; margin-top:2px; }
    #procedimentos { margin-top:8px; }
    .actions { margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; }
    .btn-danger { background:#ffe8e8; border-color:#e06; }
    .btn-primary { background:#e8f4ff; border-color:#39f; }
  </style>
</head>
<body>

<h1>Faturamento de Cirurgias Eletivas (SESAP)</h1>

<form id="formMain" onsubmit="event.preventDefault(); gerarPdf({ preview: false });">

  <label>Hospital
    <input id="hospital" type="text" value="HOSPITAL RIO GRANDE">
  </label>

  <div class="h-row">
    <div style="flex:0 0 220px;">
      <label>Data
        <input id="data" type="date">
      </label>
    </div>
    <div style="flex:1;">
      <label>Nome do cirurgião
        <input id="cirurgiao" type="text" value="José Augusto">
      </label>
    </div>
  </div>

  <label>Nome do médico auxiliar
    <input id="auxiliar" type="text" value="">
  </label>

  <label>Nome do anestesista
    <input id="anest" type="text" value="Thiago José">
  </label>

  <div class="h-row">
    <div style="flex:1;">
      <label>Empresa do cirurgião
        <input id="emp_cir" type="text" value="Targino & Rocha">
      </label>
    </div>
    <div style="flex:1;">
      <label>Empresa do anestesista
        <input id="emp_anest" type="text" value="COOPANEST RN">
      </label>
    </div>
  </div>

  <label>Nome do paciente (é repetido automaticamente)
    <input id="paciente" type="text" placeholder="Nome completo do paciente">
  </label>

  <h2 style="margin-top:18px;">Procedimentos</h2>
  <div class="muted">Arraste as linhas para reordenar. Use "Duplicar última linha" para agilizar.</div>

  <div id="procedimentos"></div>

  <div class="controls-line">
    <button type="button" onclick="addProc()" class="small">+ Adicionar procedimento</button>
    <button type="button" onclick="duplicarUltima()" class="small">Duplicar última linha</button>
    <button type="button" onclick="limparProcedimentos()" class="small btn-danger">Limpar procedimentos</button>
    <button type="button" onclick="salvarManualmente()" class="small">Salvar agora</button>
  </div>

  <div class="actions">
    <button type="button" onclick="gerarPdf({ preview: true })" class="btn-primary">Pré-visualizar PDF</button>
    <button type="submit">Gerar e baixar PDF</button>
    <button type="button" onclick="limparTudo()" class="btn-danger">Resetar tudo (padrões)</button>
  </div>

  <div class="muted" style="margin-top:8px;">
    Os dados são salvos automaticamente no navegador (localStorage).
  </div>
</form>

<script>
/*
  Versão com:
   - localStorage auto-save / restore
   - preview em nova aba
   - shrink-to-fit heurístico por campo
   - duplicar última linha
   - drag & drop reordering
   - mantém compatibilidade com o seu sesap.pdf (campos pré-nomeados)

  OBS: mantenha 'sesap.pdf' na mesma pasta do index.html
*/

const STORAGE_KEY = "sesap_form_v1";

// --- utilidades DOM
function q(id){ return document.getElementById(id); }

// --- inicialização e estado
document.addEventListener("DOMContentLoaded", () => {
  // data hoje se não existir
  const hoje = new Date();
  const yyyy = hoje.getFullYear();
  const mm = String(hoje.getMonth() + 1).padStart(2, "0");
  const dd = String(hoje.getDate()).padStart(2, "0");
  if (!q("data").value) q("data").value = `${yyyy}-${mm}-${dd}`;

  carregarDoLocalStorage();
  if (getProcedimentosFromStorage().length === 0) addProc(); // pelo menos 1
  attachAutoSaveHandlers();
  renderProcedimentosUI();
});

// --- localStorage helpers
function carregarDoLocalStorage() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const obj = JSON.parse(raw);

    if (obj.hospital) q("hospital").value = obj.hospital;
    if (obj.data) q("data").value = obj.data;
    if (obj.cirurgiao) q("cirurgiao").value = obj.cirurgiao;
    if (obj.auxiliar) q("auxiliar").value = obj.auxiliar;
    if (obj.anest) q("anest").value = obj.anest;
    if (obj.emp_cir) q("emp_cir").value = obj.emp_cir;
    if (obj.emp_anest) q("emp_anest").value = obj.emp_anest;
    if (obj.paciente) q("paciente").value = obj.paciente;
    if (Array.isArray(obj.procedimentos)) {
      localStorage.setItem(`${STORAGE_KEY}_procedimentos`, JSON.stringify(obj.procedimentos));
    }
  } catch(e) { console.warn("Erro ao carregar localStorage:", e); }
}

function salvarNoLocalStorage() {
  try {
    const state = {
      hospital: q("hospital").value,
      data: q("data").value,
      cirurgiao: q("cirurgiao").value,
      auxiliar: q("auxiliar").value,
      anest: q("anest").value,
      emp_cir: q("emp_cir").value,
      emp_anest: q("emp_anest").value,
      paciente: q("paciente").value,
      procedimentos: getProcedimentosFromUI()
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    localStorage.setItem(`${STORAGE_KEY}_procedimentos`, JSON.stringify(state.procedimentos));
    //console.debug("Salvo");
  } catch(e){ console.warn(e); }
}

function salvarManualmente(){
  salvarNoLocalStorage();
  alert("Salvo localmente.");
}

function limparTudo() {
  if (!confirm("Resetar tudo para os padrões e limpar procedimentos?")) return;
  localStorage.removeItem(STORAGE_KEY);
  localStorage.removeItem(`${STORAGE_KEY}_procedimentos`);
  // valores padrão:
  q("hospital").value = "HOSPITAL RIO GRANDE";
  const hoje = new Date();
  q("data").value = `${hoje.getFullYear()}-${String(hoje.getMonth()+1).padStart(2,"0")}-${String(hoje.getDate()).padStart(2,"0")}`;
  q("cirurgiao").value = "José Augusto";
  q("auxiliar").value = "";
  q("anest").value = "Thiago José";
  q("emp_cir").value = "Targino & Rocha";
  q("emp_anest").value = "COOPANEST RN";
  q("paciente").value = "";
  localStorage.removeItem(`${STORAGE_KEY}_procedimentos`);
  renderProcedimentosUI();
}

// procedimentos persistidos separadamente (lista)
function getProcedimentosFromStorage() {
  try {
    const raw = localStorage.getItem(`${STORAGE_KEY}_procedimentos`);
    if (!raw) return [];
    return JSON.parse(raw);
  } catch(e){ return []; }
}

// --- UI procedimentos
function getProcedimentosFromUI() {
  const nodes = document.querySelectorAll("#procedimentos .linha-proc");
  const arr = [];
  nodes.forEach(n => {
    const desc = n.querySelector('input[name="procedimento"]').value.trim();
    const grupo = n.querySelector('input[name="grupo"]').value.trim();
    if (desc || grupo) arr.push({ descricao: desc, grupo });
  });
  return arr;
}

function renderProcedimentosUI() {
  const cont = q("procedimentos");
  cont.innerHTML = "";
  const list = getProcedimentosFromStorage();
  if (list.length === 0) {
    // se não há nada salvo, tenta tirar do localStorage geral (carregado antes)
    const mainSaved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
    if (Array.isArray(mainSaved.procedimentos) && mainSaved.procedimentos.length) {
      mainSaved.procedimentos.forEach(p => addProc(p.descricao,p.grupo));
      return;
    }
    addProc(); // pelo menos uma linha vazia
    return;
  }
  list.forEach(p => addProc(p.descricao || "", p.grupo || ""));
}

// cria e anexa nova linha (opcional: preenche valores)
function addProc(descricao = "", grupo = "") {
  const cont = q("procedimentos");
  const wrapper = document.createElement("div");
  wrapper.className = "linha-proc";
  wrapper.draggable = true;

  wrapper.innerHTML = `
    <input name="procedimento" placeholder="Descrição do procedimento" value="${escapeHtml(descricao)}">
    <input name="grupo" placeholder="Grupo do procedimento" value="${escapeHtml(grupo)}">
    <div class="proc-controls">
      <button type="button" class="small" title="Remover" onclick="(function(el){ el.parentNode.removeChild(el); salvarNoLocalStorage(); })(this.closest('.linha-proc'));">✕</button>
    </div>
  `;

  // drag handlers
  wrapper.addEventListener("dragstart", (e) => {
    wrapper.classList.add("dragging");
    e.dataTransfer.setData("text/plain", "dragging"); // required for firefox
    window._dragSrc = wrapper;
  });
  wrapper.addEventListener("dragend", () => {
    wrapper.classList.remove("dragging");
    window._dragSrc = null;
    // atualiza persistência
    salvarNoLocalStorage();
  });
  wrapper.addEventListener("dragover", (e) => {
    e.preventDefault();
    const src = window._dragSrc;
    if (!src || src === wrapper) return;
    const parent = wrapper.parentNode;
    // posição: se o cursor está na metade superior, insertBefore; senão insertAfter
    const rect = wrapper.getBoundingClientRect();
    const mid = rect.top + rect.height/2;
    if (e.clientY < mid) parent.insertBefore(src, wrapper);
    else parent.insertBefore(src, wrapper.nextSibling);
  });

  cont.appendChild(wrapper);
  // salvar após adição
  salvarNoLocalStorage();
  return wrapper;
}

function duplicarUltima() {
  const nodes = document.querySelectorAll("#procedimentos .linha-proc");
  if (!nodes.length) { addProc(); return; }
  const last = nodes[nodes.length - 1];
  const desc = last.querySelector('input[name="procedimento"]').value;
  const grupo = last.querySelector('input[name="grupo"]').value;
  addProc(desc, grupo);
}

// limpa todas as linhas de procedimento
function limparProcedimentos(){
  if (!confirm("Remover todos os procedimentos?")) return;
  localStorage.removeItem(`${STORAGE_KEY}_procedimentos`);
  renderProcedimentosUI();
}

// salva automaticamente ao mudar campos
function attachAutoSaveHandlers(){
  const inputs = Array.from(document.querySelectorAll("input"));
  inputs.forEach(inp => inp.addEventListener("input", () => {
    // espera pequeno debounce
    if (window._saveTimer) clearTimeout(window._saveTimer);
    window._saveTimer = setTimeout(() => {
      // salva procedimentos atuais (se houver)
      const procs = getProcedimentosFromUI();
      localStorage.setItem(`${STORAGE_KEY}_procedimentos`, JSON.stringify(procs));
      salvarNoLocalStorage();
    }, 350);
  }));
}

// escape simples para injetar values em value attributes
function escapeHtml(s) {
  if (!s) return "";
  return s.replaceAll('"','&quot;').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}


// ----------------- Gerar PDF / lógica principal -----------------

// heurística de shrink-to-fit baseada no comprimento do texto
function computeFontSizeForField(fieldType, text) {
  // fieldType: 'procedimento','paciente','grupo','medico'
  // retornamos um fontSize em pt
  const len = (text || "").length;
  if (fieldType === "procedimento") {
    if (len <= 30) return 9;
    if (len <= 60) return 8;
    if (len <= 100) return 7;
    return 6.5;
  }
  if (fieldType === "paciente") {
    if (len <= 30) return 9;
    if (len <= 60) return 8;
    return 7.5;
  }
  if (fieldType === "grupo") {
    if (len <= 16) return 9;
    if (len <= 30) return 8;
    return 7.5;
  }
  // medico
  if (len <= 28) return 10;
  if (len <= 50) return 9;
  return 8;
}

async function gerarPdf({ preview = false } = {}) {
  const { PDFDocument } = PDFLib;

  // valores
  const hospitalVal  = q("hospital").value;
  const dataInput    = q("data").value;
  const cirurgiaoVal = q("cirurgiao").value;
  const auxiliarVal  = q("auxiliar").value;
  const anestVal     = q("anest").value;
  const empCirVal    = q("emp_cir").value;
  const empAnestVal  = q("emp_anest").value;
  const pacienteVal  = q("paciente").value;

  if (!pacienteVal) { alert("Informe o nome do paciente."); return; }

  // formata data show
  let dataStr = "";
  if (dataInput) {
    const [yyyy, mm, dd] = dataInput.split("-");
    dataStr = `${dd}/${mm}/${yyyy}`;
  }

  // equipe
  const equipeTexto = `Cirurgião: ${cirurgiaoVal} / Auxiliar: ${auxiliarVal} / Anest.: ${anestVal}`;

  // procedimentos
  const procedimentos = getProcedimentosFromUI();
  if (!procedimentos.length) { alert("Informe pelo menos 1 procedimento."); return; }

  // guarda no storage (atualiza)
  salvarNoLocalStorage();

  // carrega template
  let templateBytes;
  try {
    templateBytes = await fetch("sesap.pdf").then(r => {
      if (!r.ok) throw new Error("Não encontrou 'sesap.pdf' (verifique caminho)");
      return r.arrayBuffer();
    });
  } catch(e) {
    alert("Erro carregando sesap.pdf: " + e.message);
    return;
  }

  const docFinal = await PDFDocument.create();

  // divide em blocos de 5
  function em_blocos(lista, tam = 5) {
    const out = [];
    for (let i = 0; i < lista.length; i += tam) out.push(lista.slice(i, i+tam));
    return out;
  }

  // preenche uma página (tipo = 'cirurgia' ou 'anestesia')
  async function adicionarPagina(tipo, bloco) {
    const tempDoc = await PDFDocument.load(templateBytes);
    const form = tempDoc.getForm();

    // Campos superiores
    const fHospital = form.getTextField("HOSPITAL");
    const fEmpresa  = form.getTextField("EMPRESA");
    const fData     = form.getTextField("DATA");
    const fEquipe   = form.getTextField("EQUIPE");

    fHospital.setText(hospitalVal || "");
    fHospital.setFontSize(11);
    fEmpresa.setText(tipo === "cirurgia" ? (empCirVal || "") : (empAnestVal || ""));
    fEmpresa.setFontSize(11);
    fData.setText(dataStr || "");
    fData.setFontSize(10);
    fEquipe.setText(equipeTexto || "");
    fEquipe.setFontSize(9);

    // preenche 5 linhas
    for (let i = 0; i < 5; i++) {
      const idx = i+1;
      const suf = String(idx).padStart(2, "0"); // 01,02...
      const linha = bloco[i];

      const campoProc     = form.getTextField(`PROCEDIMENTO_${suf}`);
      const campoPac      = form.getTextField(`PACIENTE${suf}`);
      const campoGrupo    = form.getTextField(`GRUPOP${idx}`);
      const campoMedPrinc = form.getTextField(`MEDICO_PRINC_${suf}`);
      const campoMedAux   = form.getTextField(`MEDICO_AUX_${suf}`);

      // deixa multiline (importante para procedimentos longos)
      try { campoProc.enableMultiline(); } catch(e){/* ignore se não suportar */ }

      // decide textos e tamanhos (shrink heurístico)
      if (linha && linha.descricao) {
        const procText = linha.descricao;
        const pacientText = pacienteVal;
        const grupoText = linha.grupo || "";

        const sizeProc = computeFontSizeForField("procedimento", procText);
        const sizePaciente = computeFontSizeForField("paciente", pacientText);
        const sizeGrupo = computeFontSizeForField("grupo", grupoText);

        campoProc.setFontSize(sizeProc);
        campoPac.setFontSize(sizePaciente);
        campoGrupo.setFontSize(sizeGrupo);

        campoProc.setText(procText);
        campoPac.setText(pacientText);
        campoGrupo.setText(grupoText);

        if (tipo === "cirurgia") {
          campoMedPrinc.setFontSize(computeFontSizeForField("medico", cirurgiaoVal));
          campoMedAux.setFontSize(computeFontSizeForField("medico", auxiliarVal));
          campoMedPrinc.setText(cirurgiaoVal || "");
          campoMedAux.setText(auxiliarVal || "");
        } else {
          campoMedPrinc.setFontSize(computeFontSizeForField("medico", anestVal));
          campoMedAux.setFontSize(computeFontSizeForField("medico", ""));
          campoMedPrinc.setText(anestVal || "");
          campoMedAux.setText("");
        }

      } else {
        // campos em branco
        campoProc.setText("");
        campoPac.setText("");
        campoGrupo.setText("");
        campoMedPrinc.setText("");
        campoMedAux.setText("");
      }
    }

    // flatten para fixar o texto
    try { form.flatten(); } catch(e){ /* ignore */ }

    const [page] = await docFinal.copyPages(tempDoc, [0]);
    docFinal.addPage(page);
  }

  const blocos = em_blocos(procedimentos, 5);
  for (const bloco of blocos) {
    await adicionarPagina("cirurgia", bloco);
    await adicionarPagina("anestesia", bloco);
  }

  const pdfBytes = await docFinal.save();
  const blob = new Blob([pdfBytes], { type: "application/pdf" });
  const url = URL.createObjectURL(blob);

  if (preview) {
    // abre em nova aba
    window.open(url, "_blank");
    // nota: não revoke imediatamente pois aba pode ainda carregar. Vamos revogar após 30s.
    setTimeout(() => URL.revokeObjectURL(url), 30000);
  } else {
    // download
    const a = document.createElement("a");
    a.href = url;
    a.download = "faturamento_sesap.pdf";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 2000);
  }
}

// ----------------- fim -----------------
</script>

</body>
</html>
