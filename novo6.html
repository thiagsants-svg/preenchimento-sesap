<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Faturamento SESAP ‚Äî Gerador de PDFs</title>

  <!-- pdf-lib -->
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --muted:#6b7280;
      --primary:#0366d6;
      --accent:#06b6d4;
      --danger:#ef4444;
      --radius:10px;
      --shadow: 0 6px 18px rgba(15,23,42,0.06);
      --mono: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    html,body{height:100%; margin:0; font-family:var(--mono); background:linear-gradient(180deg,#f8fbff 0%,var(--bg) 100%); color:#0f172a;}
    .container{max-width:1100px; margin:28px auto; padding:20px;}
    header{display:flex;align-items:center;gap:14px;margin-bottom:18px;}
    .logo{width:56px;height:56px;background:linear-gradient(135deg,var(--primary),#4f46e5);border-radius:12px;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;box-shadow:var(--shadow)}
    h1{font-size:1.25rem;margin:0}
    p.lead{margin:4px 0 0;color:var(--muted);font-size:0.95rem}

    .grid{display:grid;grid-template-columns:1fr 420px;gap:18px;align-items:start}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .form-row{display:flex;gap:10px}
    .form-row .col{flex:1}
    label{display:block;font-size:0.85rem;color:#0f172a;margin-bottom:6px;font-weight:600}
    input[type="text"], input[type="date"], select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef8;background:#fff;box-sizing:border-box;font-size:0.95rem}
    .muted{color:var(--muted);font-size:0.9rem}

    /* procedimentos area */
    #procedimentos{margin-top:10px; display:flex;flex-direction:column;gap:10px; max-height:460px; overflow:auto; padding-right:4px}
    .linha-proc{display:grid;grid-template-columns: 1fr 160px 44px;gap:10px;align-items:center;padding:10px;border-radius:8px;background:linear-gradient(180deg,#fff,#fbfdff);border:1px solid #eef6ff}
    .linha-proc.dragging{opacity:0.65; transform:scale(0.995); box-shadow:0 10px 24px rgba(2,6,23,0.06)}
    .linha-proc input{padding:8px;border-radius:6px;border:1px solid #e7f0fb;background:white}
    .proc-actions{display:flex;flex-direction:column;gap:6px;align-items:center}
    .small-btn{border:0;background:#f3f7ff;color:var(--primary);padding:6px 8px;border-radius:6px;cursor:pointer;font-weight:700}
    .small-btn.danger{background:#fff5f5;color:var(--danger);border:1px solid rgba(239,68,68,0.12)}

    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .btn.primary{background:linear-gradient(90deg,var(--primary),#4f46e5);color:white;box-shadow:0 8px 20px rgba(3,102,214,0.12)}
    .btn.ghost{background:transparent;border:1px solid #dbeafe;color:var(--primary)}
    .btn.warn{background:linear-gradient(90deg,#f59e0b,#f97316);color:white}
    .btn.danger{background:linear-gradient(90deg,#fee2e2,#fecaca);color:var(--danger);border:1px solid rgba(239,68,68,0.14)}

    .side-card{position:sticky;top:18px}
    .meta{display:flex;flex-direction:column;gap:8px}
    .meta .row{display:flex;gap:8px;align-items:center}
    .kpi{background:linear-gradient(180deg,#fff,#f8fbff);padding:10px;border-radius:8px;border:1px solid #eef6ff}
    .muted-small{color:var(--muted);font-size:0.85rem}

    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:0.9rem}

    /* responsive tweaks */
    @media (max-width:560px){
      .linha-proc{grid-template-columns:1fr 120px 44px}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">FG</div>
      <div>
        <h1>Gerador de Faturamento ‚Äî SESAP</h1>
        <p class="lead">Preencha os campos e gere o PDF pronto para impress√£o. Dados salvos localmente.</p>
      </div>
    </header>

    <div class="grid">
      <!-- main form -->
      <div>
        <div class="card">
          <div style="display:flex;gap:12px;flex-direction:column">
            <div class="form-row" style="align-items:center">
              <div style="flex:1">
                <label for="hospital">Hospital</label>
                <input id="hospital" type="text" value="HOSPITAL RIO GRANDE" />
              </div>
              <div style="width:220px">
                <label for="data">Data</label>
                <input id="data" type="date" />
              </div>
            </div>

            <div class="form-row" style="margin-top:8px">
              <div class="col">
                <label for="cirurgiao_select">Cirurgi√£o</label>
                <div style="display:flex;gap:8px">
                  <select id="cirurgiao_select">
                    <option value="Jos√© Augusto">Jos√© Augusto</option>
                    <option value="Harue Kumakura">Harue Kumakura</option>
                    <option value="Jos√© Linhares">Jos√© Linhares</option>
                    <option value="Yuri Louren√ßo">Yuri Louren√ßo</option>
                    <option value="__outro__">Outro...</option>
                  </select>
                  <input id="cirurgiao_outro" type="text" placeholder="Outro cirurgi√£o" style="display:none;flex:1" />
                </div>
              </div>

              <div class="col" style="min-width:220px">
                <label for="aux_select">Auxiliar</label>
                <div style="display:flex;gap:8px">
                  <select id="aux_select">
                    <option value="">-- selecionar --</option>
                    <option value="Harue Kumakura">Harue Kumakura</option>
                    <option value="Jos√© Linhares">Jos√© Linhares</option>
                    <option value="Yuri Louren√ßo">Yuri Louren√ßo</option>
                    <option value="__outro__">Outro...</option>
                  </select>
                  <input id="aux_outro" type="text" placeholder="Outro auxiliar" style="display:none;flex:1" />
                </div>
              </div>
            </div>

            <div class="form-row" style="margin-top:8px">
              <div style="flex:1">
                <label for="anest_select">Anestesista</label>
                <div style="display:flex;gap:8px">
                  <select id="anest_select">
                    <option value="Thiago Jos√©">Thiago Jos√©</option>
                    <option value="Bruno Sinedino">Bruno Sinedino</option>
                    <option value="__outro__">Outro...</option>
                  </select>
                  <input id="anest_outro" type="text" placeholder="Outro anestesista" style="display:none;flex:1" />
                </div>
              </div>

              <div style="flex:1">
                <label for="emp_cir">Empresa do cirurgi√£o</label>
                <input id="emp_cir" type="text" value="Targino & Rocha" />
              </div>
            </div>

            <div class="form-row" style="margin-top:8px">
              <div style="flex:1">
                <label for="emp_anest">Empresa do anestesista</label>
                <input id="emp_anest" type="text" value="COOPANEST RN" />
              </div>
              <div style="flex:1">
                <label for="paciente">Paciente</label>
                <input id="paciente" type="text" placeholder="Nome completo do paciente" />
              </div>
            </div>

            <hr style="margin:14px 0;border:none;border-top:1px solid #eef6ff" />

            <div style="display:flex;align-items:center;justify-content:space-between">
              <div>
                <h3 style="margin:0">Procedimentos</h3>
                <div class="muted-small" style="margin-top:6px">Arraste para reordenar ‚Ä¢ M√°x. 5 por p√°gina (ser√° gerado Cirurgia + Anestesia)</div>
              </div>
              <div style="display:flex;gap:8px">
                <button type="button" class="small-btn" onclick="duplicarUltima()" title="Duplicar √∫ltima linha">‚éò Duplicar</button>
                <button type="button" class="small-btn" onclick="addProc()" title="Adicionar">Ôºã Adicionar</button>
                <button type="button" class="small-btn danger" onclick="limparProcedimentos()" title="Limpar">‚úï Limpar</button>
              </div>
            </div>

            <div id="procedimentos" style="margin-top:12px"></div>

            <div class="controls" style="margin-top:14px">
              <button type="button" class="btn primary" onclick="gerarPdf({preview:true})">üîç Pr√©-visualizar PDF</button>
              <button type="button" class="btn ghost" onclick="gerarPdf({preview:false})">‚¨áÔ∏è Gerar e baixar</button>
              <button type="button" class="btn warn" onclick="salvarManualmente()">üíæ Salvar</button>
              <button type="button" class="btn danger" onclick="limparTudo()">‚ôªÔ∏è Resetar tudo</button>
            </div>

            <div style="margin-top:10px;color:var(--muted);font-size:0.9rem">
              Os dados s√£o salvos automaticamente no navegador (localStorage).
            </div>
          </div>
        </div>
      </div>

      <!-- side -->
      <div class="side-card">
        <div class="card meta">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Resumo</strong><div class="muted-small">Cheque antes de gerar</div></div>
            <div style="text-align:right"><span id="count-proc">0</span> procedimentos</div>
          </div>

          <div style="margin-top:12px">
            <div class="kpi">
              <div style="font-size:0.95rem"><strong>Equipe</strong></div>
              <div class="muted-small" id="preview-equipe">‚Äî</div>
            </div>
          </div>

          <div style="margin-top:12px">
            <div class="kpi">
              <div style="font-size:0.95rem"><strong>Hospital / Data</strong></div>
              <div class="muted-small" id="preview-hospital">‚Äî</div>
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="small-btn" onclick="salvarManualmente()">Salvar</button>
            <button class="small-btn" onclick="location.reload()">Recarregar</button>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="card">
          <div style="font-weight:700;margin-bottom:6px">Ajuda r√°pida</div>
          <div class="muted-small">‚Ä¢ Use "Duplicar" para repetir a √∫ltima linha.<br>‚Ä¢ Reordene arrastando. <br>‚Ä¢ M√°ximo 5 procedimentos por p√°gina (o sistema gera p√°ginas extras automaticamente).</div>
        </div>
      </div>
    </div>

    <footer>
      Desenvolvido ‚Äî Gerador autom√°tico SESAP ‚Ä¢ Dados locais no seu navegador
    </footer>
  </div>

<script>
/* Modernized index.html with:
   - dropdowns for cirurgiao and anestesista with "Outro..."
   - localStorage save/restore
   - preview & download
   - shrink-to-fit heuristics
   - duplicar ultima linha + drag & drop reorder
*/

const STORAGE_KEY = "sesap_form_v2";

function q(id){ return document.getElementById(id); }

// INIT
document.addEventListener("DOMContentLoaded", () => {
  // set hoje
  const hoje = new Date();
  const yyyy = hoje.getFullYear();
  const mm = String(hoje.getMonth() + 1).padStart(2, "0");
  const dd = String(hoje.getDate()).padStart(2, "0");
  if (!q("data").value) q("data").value = `${yyyy}-${mm}-${dd}`;

  carregarDoLocalStorage();
  if (getProcedimentosFromStorage().length === 0) addProc();
  attachAutoSaveHandlers();
  renderProcedimentosUI();
  hookDropdowns();
  updateSidePreview();
});

// ---------- localStorage ----------
function carregarDoLocalStorage(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const s = JSON.parse(raw);
    if (s.hospital) q("hospital").value = s.hospital;
    if (s.data) q("data").value = s.data;
    if (s.emp_cir) q("emp_cir").value = s.emp_cir;
    if (s.emp_anest) q("emp_anest").value = s.emp_anest;
    if (s.paciente) q("paciente").value = s.paciente;

    // cirurgiao: if matches option, select; else set other
    if (s.cirurgiao !== undefined) {
      const opts = ["Jos√© Augusto","Harue Kumakura","Jos√© Linhares","Yuri Louren√ßo"];
      if (opts.includes(s.cirurgiao)) {
        q("cirurgiao_select").value = s.cirurgiao;
        q("cirurgiao_outro").style.display = "none";
      } else if (s.cirurgiao === "") {
        q("cirurgiao_select").value = "Jos√© Augusto";
        q("cirurgiao_outro").style.display = "none";
      } else {
        q("cirurgiao_select").value = "__outro__";
        q("cirurgiao_outro").style.display = "block";
        q("cirurgiao_outro").value = s.cirurgiao;
      }
    }

    // auxiliar
    if (s.auxiliar !== undefined) {
      const opts = ["Harue Kumakura","Jos√© Linhares","Yuri Louren√ßo"];
      if (opts.includes(s.auxiliar)) {
        q("aux_select").value = s.auxiliar;
        q("aux_outro").style.display = "none";
      } else if (s.auxiliar === "") {
        q("aux_select").value = "";
        q("aux_outro").style.display = "none";
      } else {
        q("aux_select").value = "__outro__";
        q("aux_outro").style.display = "block";
        q("aux_outro").value = s.auxiliar;
      }
    }

    // anestesista
    if (s.anest !== undefined) {
      const opts = ["Thiago Jos√©","Bruno Sinedino"];
      if (opts.includes(s.anest)) {
        q("anest_select").value = s.anest;
        q("anest_outro").style.display = "none";
      } else if (s.anest === "") {
        q("anest_select").value = "Thiago Jos√©";
        q("anest_outro").style.display = "none";
      } else {
        q("anest_select").value = "__outro__";
        q("anest_outro").style.display = "block";
        q("anest_outro").value = s.anest;
      }
    }

    if (Array.isArray(s.procedimentos)) {
      localStorage.setItem(`${STORAGE_KEY}_procedimentos`, JSON.stringify(s.procedimentos));
    }
  }catch(e){ console.warn("storage load err", e); }
}

function salvarNoLocalStorage(){
  try {
    const state = {
      hospital: q("hospital").value,
      data: q("data").value,
      cirurgiao: getCirurgiaoValueForSave(),
      auxiliar: getAuxiliarValueForSave(),
      anest: getAnestValueForSave(),
      emp_cir: q("emp_cir").value,
      emp_anest: q("emp_anest").value,
      paciente: q("paciente").value,
      procedimentos: getProcedimentosFromUI()
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    localStorage.setItem(`${STORAGE_KEY}_procedimentos`, JSON.stringify(state.procedimentos));
    updateSidePreview();
  } catch(e) { console.warn(e); }
}

function salvarManualmente(){ salvarNoLocalStorage(); alert("Salvo localmente."); }

function limparTudo(){
  if (!confirm("Resetar tudo para os padr√µes?")) return;
  localStorage.removeItem(STORAGE_KEY);
  localStorage.removeItem(`${STORAGE_KEY}_procedimentos`);
  q("hospital").value = "HOSPITAL RIO GRANDE";
  const hoje = new Date();
  q("data").value = `${hoje.getFullYear()}-${String(hoje.getMonth()+1).padStart(2,"0")}-${String(hoje.getDate()).padStart(2,"0")}`;
  q("cirurgiao_select").value = "Jos√© Augusto";
  q("cirurgiao_outro").value = ""; q("cirurgiao_outro").style.display = "none";
  q("aux_select").value = ""; q("aux_outro").value=""; q("aux_outro").style.display="none";
  q("anest_select").value = "Thiago Jos√©"; q("anest_outro").value=""; q("anest_outro").style.display="none";
  q("emp_cir").value = "Targino & Rocha";
  q("emp_anest").value = "COOPANEST RN";
  q("paciente").value = "";
  localStorage.removeItem(`${STORAGE_KEY}_procedimentos`);
  renderProcedimentosUI();
  salvarNoLocalStorage();
}

// procedimentos storage
function getProcedimentosFromStorage(){
  try {
    const raw = localStorage.getItem(`${STORAGE_KEY}_procedimentos`);
    if (!raw) return [];
    return JSON.parse(raw);
  } catch(e){ return []; }
}

// UI procedures
function getProcedimentosFromUI(){
  const nodes = document.querySelectorAll("#procedimentos .linha-proc");
  const arr = [];
  nodes.forEach(n => {
    const desc = n.querySelector('input[name="procedimento"]').value.trim();
    const grupo = n.querySelector('input[name="grupo"]').value.trim();
    if (desc || grupo) arr.push({descricao:desc, grupo});
  });
  q("count-proc").innerText = arr.length;
  return arr;
}

function renderProcedimentosUI(){
  const cont = q("procedimentos");
  cont.innerHTML = "";
  const list = getProcedimentosFromStorage();
  if (list.length === 0) {
    const mainSaved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
    if (Array.isArray(mainSaved.procedimentos) && mainSaved.procedimentos.length) {
      mainSaved.procedimentos.forEach(p => addProc(p.descricao,p.grupo));
      return;
    }
    addProc();
    return;
  }
  list.forEach(p => addProc(p.descricao || "", p.grupo || ""));
}

function addProc(descricao="", grupo=""){
  const cont = q("procedimentos");
  const wrapper = document.createElement("div");
  wrapper.className = "linha-proc";
  wrapper.draggable = true;
  wrapper.innerHTML = `
    <input name="procedimento" placeholder="Descri√ß√£o do procedimento" value="${escapeHtml(descricao)}" />
    <input name="grupo" placeholder="Grupo do procedimento" value="${escapeHtml(grupo)}" />
    <div class="proc-actions">
      <button class="small-btn" type="button" title="Remover" onclick="(function(el){ el.parentNode.removeChild(el); salvarNoLocalStorage(); })(this.closest('.linha-proc'));">‚úï</button>
    </div>
  `;

  // drag handlers
  wrapper.addEventListener("dragstart", (e) => {
    wrapper.classList.add("dragging");
    e.dataTransfer.setData("text/plain", "drag");
    window._dragSrc = wrapper;
  });
  wrapper.addEventListener("dragend", () => {
    wrapper.classList.remove("dragging");
    window._dragSrc = null;
    salvarNoLocalStorage();
  });
  wrapper.addEventListener("dragover", (e) => {
    e.preventDefault();
    const src = window._dragSrc;
    if (!src || src === wrapper) return;
    const parent = wrapper.parentNode;
    const rect = wrapper.getBoundingClientRect();
    const mid = rect.top + rect.height/2;
    if (e.clientY < mid) parent.insertBefore(src, wrapper);
    else parent.insertBefore(src, wrapper.nextSibling);
  });

  cont.appendChild(wrapper);
  salvarNoLocalStorage();
  updateSidePreview();
  return wrapper;
}

function duplicarUltima() {
  const nodes = document.querySelectorAll("#procedimentos .linha-proc");
  if (!nodes.length) { addProc(); return; }
  const last = nodes[nodes.length - 1];
  const desc = last.querySelector('input[name="procedimento"]').value;
  const grupo = last.querySelector('input[name="grupo"]').value;
  addProc(desc, grupo);
}

function limparProcedimentos(){
  if (!confirm("Remover todos os procedimentos?")) return;
  localStorage.removeItem(`${STORAGE_KEY}_procedimentos`);
  renderProcedimentosUI();
  salvarNoLocalStorage();
}

// auto save handlers
function attachAutoSaveHandlers(){
  const inputs = Array.from(document.querySelectorAll("input, select"));
  inputs.forEach(inp => inp.addEventListener("input", () => {
    if (window._saveTimer) clearTimeout(window._saveTimer);
    window._saveTimer = setTimeout(() => {
      const procs = getProcedimentosFromUI();
      localStorage.setItem(`${STORAGE_KEY}_procedimentos`, JSON.stringify(procs));
      salvarNoLocalStorage();
    }, 300);
  }));
}

// escaping
function escapeHtml(s){ if (!s) return ""; return s.replaceAll('"','&quot;').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

// Dropdown hooks for cirurgiao/aux/anest
function hookDropdowns(){
  // cirurgiao
  const cs = q("cirurgiao_select"), co = q("cirurgiao_outro");
  cs.addEventListener("change", () => {
    if (cs.value === "__outro__") { co.style.display = "block"; co.focus(); } else co.style.display = "none";
    salvarNoLocalStorage();
  });
  co.addEventListener("input", salvarNoLocalStorage);

  // auxiliar
  const asel = q("aux_select"), aout = q("aux_outro");
  asel.addEventListener("change", () => {
    if (asel.value === "__outro__") { aout.style.display="block"; aout.focus(); } else aout.style.display="none";
    salvarNoLocalStorage();
  });
  aout.addEventListener("input", salvarNoLocalStorage);

  // anest
  const an = q("anest_select"), anout = q("anest_outro");
  an.addEventListener("change", () => {
    if (an.value === "__outro__") { anout.style.display="block"; anout.focus(); } else anout.style.display="none";
    salvarNoLocalStorage();
  });
  anout.addEventListener("input", salvarNoLocalStorage);
}

function getCirurgiaoValueForSave(){
  const sel = q("cirurgiao_select").value;
  if (sel === "__outro__") return q("cirurgiao_outro").value.trim();
  return sel;
}
function getAuxiliarValueForSave(){
  const sel = q("aux_select").value;
  if (sel === "__outro__") return q("aux_outro").value.trim();
  return sel;
}
function getAnestValueForSave(){
  const sel = q("anest_select").value;
  if (sel === "__outro__") return q("anest_outro").value.trim();
  return sel;
}

// side preview
function updateSidePreview(){
  const cir = getCirurgiaoValueForSave() || "‚Äî";
  const aux = getAuxiliarValueForSave() || "‚Äî";
  const anest = getAnestValueForSave() || "‚Äî";
  q("preview-equipe").innerText = `Cirurgi√£o: ${cir} ‚Ä¢ Auxiliar: ${aux} ‚Ä¢ Anest.: ${anest}`;
  q("preview-hospital").innerText = `${q("hospital").value || "‚Äî"} ‚Ä¢ ${q("data").value || "‚Äî"}`;
  q("count-proc").innerText = getProcedimentosFromUI().length;
}

// shrink heuristics
function computeFontSizeForField(fieldType, text) {
  const len = (text || "").length;
  if (fieldType === "procedimento") {
    if (len <= 30) return 9;
    if (len <= 60) return 8;
    if (len <= 100) return 7;
    return 6.5;
  }
  if (fieldType === "paciente") {
    if (len <= 30) return 9;
    if (len <= 60) return 8;
    return 7.5;
  }
  if (fieldType === "grupo") {
    if (len <= 16) return 9;
    if (len <= 30) return 8;
    return 7.5;
  }
  if (len <= 28) return 10;
  if (len <= 50) return 9;
  return 8;
}

// ------------ PDF generation ---------------
async function gerarPdf({ preview = false } = {}) {
  const { PDFDocument } = PDFLib;

  const hospitalVal  = q("hospital").value;
  const dataInput    = q("data").value;
  const cirurgiaoVal = getCirurgiaoValueForSave();
  const auxiliarVal  = getAuxiliarValueForSave();
  const anestVal     = getAnestValueForSave();
  const empCirVal    = q("emp_cir").value;
  const empAnestVal  = q("emp_anest").value;
  const pacienteVal  = q("paciente").value;

  if (!pacienteVal) { alert("Informe o nome do paciente."); return; }

  let dataStr = "";
  if (dataInput) {
    const [yyyy, mm, dd] = dataInput.split("-");
    dataStr = `${dd}/${mm}/${yyyy}`;
  }

  const equipeTexto = `Cirurgi√£o: ${cirurgiaoVal} / Auxiliar: ${auxiliarVal} / Anest.: ${anestVal}`;
  const procedimentos = getProcedimentosFromUI();
  if (!procedimentos.length) { alert("Informe pelo menos 1 procedimento."); return; }

  salvarNoLocalStorage();

  let templateBytes;
  try {
    templateBytes = await fetch("sesap.pdf").then(r => {
      if (!r.ok) throw new Error("N√£o encontrou 'sesap.pdf' (verifique caminho)");
      return r.arrayBuffer();
    });
  } catch(e) {
    alert("Erro carregando sesap.pdf: " + e.message);
    return;
  }

  const docFinal = await PDFDocument.create();

  function em_blocos(lista, tam = 5){
    const out=[]; for (let i=0;i<lista.length;i+=tam) out.push(lista.slice(i,i+tam)); return out;
  }

  async function adicionarPagina(tipo, bloco){
    const tempDoc = await PDFDocument.load(templateBytes);
    const form = tempDoc.getForm();

    const fHospital = form.getTextField("HOSPITAL");
    const fEmpresa  = form.getTextField("EMPRESA");
    const fData     = form.getTextField("DATA");
    const fEquipe   = form.getTextField("EQUIPE");

    fHospital.setText(hospitalVal || "");
    fHospital.setFontSize(11);
    fEmpresa.setText(tipo === "cirurgia" ? (empCirVal || "") : (empAnestVal || ""));
    fEmpresa.setFontSize(11);
    fData.setText(dataStr || "");
    fData.setFontSize(10);
    fEquipe.setText(equipeTexto || "");
    fEquipe.setFontSize(9);

    for (let i=0;i<5;i++){
      const idx=i+1; const suf=String(idx).padStart(2,"0"); const linha=bloco[i];
      const campoProc     = form.getTextField(`PROCEDIMENTO_${suf}`);
      const campoPac      = form.getTextField(`PACIENTE${suf}`);
      const campoGrupo    = form.getTextField(`GRUPOP${idx}`);
      const campoMedPrinc = form.getTextField(`MEDICO_PRINC_${suf}`);
      const campoMedAux   = form.getTextField(`MEDICO_AUX_${suf}`);

      try { campoProc.enableMultiline(); } catch(e){}

      if (linha && linha.descricao) {
        const procText = linha.descricao;
        const pacientText = pacienteVal;
        const grupoText = linha.grupo || "";

        const sizeProc = computeFontSizeForField("procedimento", procText);
        const sizePaciente = computeFontSizeForField("paciente", pacientText);
        const sizeGrupo = computeFontSizeForField("grupo", grupoText);

        campoProc.setFontSize(sizeProc);
        campoPac.setFontSize(sizePaciente);
        campoGrupo.setFontSize(sizeGrupo);

        campoProc.setText(procText);
        campoPac.setText(pacientText);
        campoGrupo.setText(grupoText);

        if (tipo === "cirurgia") {
          campoMedPrinc.setFontSize(computeFontSizeForField("medico", cirurgiaoVal));
          campoMedAux.setFontSize(computeFontSizeForField("medico", auxiliarVal));
          campoMedPrinc.setText(cirurgiaoVal || "");
          campoMedAux.setText(auxiliarVal || "");
        } else {
          campoMedPrinc.setFontSize(computeFontSizeForField("medico", anestVal));
          campoMedAux.setFontSize(computeFontSizeForField("medico", ""));
          campoMedPrinc.setText(anestVal || "");
          campoMedAux.setText("");
        }
      } else {
        campoProc.setText("");
        campoPac.setText("");
        campoGrupo.setText("");
        campoMedPrinc.setText("");
        campoMedAux.setText("");
      }
    }

    try { form.flatten(); } catch(e){}

    const [page] = await docFinal.copyPages(tempDoc, [0]);
    docFinal.addPage(page);
  }

  const blocos = em_blocos(procedimentos, 5);
  for (const bloco of blocos) {
    await adicionarPagina("cirurgia", bloco);
    await adicionarPagina("anestesia", bloco);
  }

  const pdfBytes = await docFinal.save();
  const blob = new Blob([pdfBytes], { type: "application/pdf" });
  const url = URL.createObjectURL(blob);

  if (preview) {
    window.open(url, "_blank");
    setTimeout(()=>URL.revokeObjectURL(url),30000);
  } else {
    const a = document.createElement("a");
    a.href = url; a.download = "faturamento_sesap.pdf"; document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url),2000);
  }
}
</script>
</body>
</html>
